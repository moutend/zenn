---
title: "URLパス文字列のエスケープに御用心"
emoji: "🔖"
type: "tech"
topics: [JavaScript, Go]
published: false
---
## はじめに

新しい話題ではありませんが、

## エスケープした結果が異なる？

URLのパス文字列をエスケープする処理、例えば`#`を`%23`に変換する処理が実装によって異なるのをご存じでしょうか？技術的に枯れていて差が発生しそうには思えませんが、そこが罠です。

以降はASCII文字のエスケープに限定して話を進めます。それでは`0x00`から`0x7f`までの文字をエスケープして、その差を確かめてみましょう。

### NodeJSのencodeURIComponent

まずはNodeJSの標準ライブラリencodeURIComponentの動作を確認しましょう。以下のコードを実行するとASCIIコードの16進数表記とエスケープの結果がタブ区切りで表示されます。

```js
for (let i = 0; i <= 0x7f; i++) {
  const input = `0x${i.toString(16)}`;
  const output = encodeURIComponent(String.fromCharCode(i));

  console.log(`${input}\t${output}`);
}
```

### Goのurl.QueryEscape

続いてGoの標準パッケージurl.QueryEscapeの動作を確認しましょう。こちらも実行するとASCIIコードの16進数表記とエスケープの結果がタブ区切りで表示されます。

```go
package main

import (
	"fmt"
	"net/url"
)

func main() {
	for i := rune(0); i <= rune(0x7f); i++ {
		input := fmt.Sprintf("%x", i)
		output := url.QueryEscape(string(i))

		fmt.Printf("0x%s\t%s\n", input, output)
	}
}
```

## エスケープした結果の比較

NodeJSのencodeURIComponentとGoのurl.QueryEscapeの差は以下のとおりです。

| ASCIIコード | NodeJS | Go |
|:---|:---|:---|
| 0x20 | `%20` | `+` |
| 0x21 | `!` | `%21` |
| 0x27 | `'` | `%27` |
| 0x28 | `(` | `%28` |
\ 0x29 | `)` | `%29` |
| 0x2a | `*` | `%2a` |

## 何が問題なのか？

さて、エスケープした結果に差が発生することは確認できました。続いて、どのような問題が発生するのか検討します。

### NodeJS実装とGo実装が同居している

わかりやすい問題はNodeJSで実装されたシステムとGoで実装されたシステムが同居している状況です。

先ほどの比較表について空白文字0x20のエスケープに注目してください。NodeJSは`%20`、Goは`+`にエスケープされます。
