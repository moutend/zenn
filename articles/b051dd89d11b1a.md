---
title: "Cloudflare Workersã«Next.jsã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹"
emoji: "ğŸ’­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Cloudflare, Nextjs]
published: true
---
## ã¯ã˜ã‚ã«

2024å¹´9æœˆã«Workers Static Assetsæ©Ÿèƒ½ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã€ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ãªNext.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚ç¾æ™‚ç‚¹ã§ã¾ã å®Ÿé¨“çš„æ©Ÿèƒ½ã®æ‰±ã„ã§ã™ãŒã€å‹•ä½œã™ã‚‹ã‹è©¦ã—ã¦ã¿ã¾ã™ã€‚

â€»Cloudflareã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯Next.js v14ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€æœ¬è¨˜äº‹ã‚‚v14ã‚’å‰æã«é€²ã‚ã¾ã™ã€‚

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã¯å¾Œã§è¡Œã†ãŸã‚ã€ã€ŒDo you want to deploy your application?ã€ã¯Noã¨å›ç­”ã—ã¦ãã ã•ã„ã€‚

```console
npm create cloudflare@latest my-next-app -- --framework=next --experimental
```

### ï¼ˆè£œè¶³ï¼‰package.jsonã«ã¤ã„ã¦

ç¾æ™‚ç‚¹ã§ã¯ä»¥ä¸‹ã®package.jsonãŒä½œæˆã•ã‚Œã¾ã™ã€‚Cloudflareã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯package.jsonã®scriptsã‚’ä¿®æ­£ã™ã‚‹ã‚ˆã†ã«æŒ‡ç¤ºã•ã‚Œã¦ã„ã¾ã™ãŒã€ä¿®æ­£ã¯ä¸è¦ã§ã™ã€‚

:::details package.jsonã®å†…å®¹

```json
{
  "name": "my-next-app",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "deploy": "opennextjs-cloudflare && wrangler deploy",
    "preview": "opennextjs-cloudflare && wrangler dev",
    "cf-typegen": "wrangler types --env-interface CloudflareEnv env.d.ts"
  },
  "dependencies": {
    "next": "14.2.5",
    "react": "^18",
    "react-dom": "^18"
  },
  "devDependencies": {
    "@cloudflare/workers-types": "^4.20250109.0",
    "@opennextjs/cloudflare": "^0.3.7",
    "@types/node": "^20",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "eslint": "^8",
    "eslint-config-next": "14.2.5",
    "postcss": "^8",
    "tailwindcss": "^3.4.1",
    "typescript": "^5",
    "wrangler": "^3.101.0"
  }
}
```

:::

## ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

ã²ã¨ã¾ãšãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã™ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```console
npm run deploy
```

è­¦å‘Šã‚„ã‚¨ãƒ©ãƒ¼ã¯ç™ºç”Ÿã›ãšãƒ‡ãƒ—ãƒ­ã‚¤ã¯æˆåŠŸã™ã‚‹ã¯ãšã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§`https://my-next-app.<your_name>.workers.dev`ã‚’é–‹ã„ã¦ã¿ã¦ãã ã•ã„ã€‚

:::details npm run deployå®Ÿè¡Œçµæœã®ä¾‹

å‚è€ƒã¾ã§ã«npm run deployå®Ÿè¡Œæ™‚ã®ãƒ­ã‚°ã‚’ç¤ºã—ã¾ã™ã€‚

```console
$ npm run deploy

> my-next-app@0.1.0 deploy
> opennextjs-cloudflare && wrangler deploy


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OpenNext â€” Cloudflare build â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

App directory: /private/tmp/my-next-app
Next.js version : 14.2.5
OpenNext v3.3.1

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OpenNext â€” Building Next.js app â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


> my-next-app@0.1.0 build
> next build

  â–² Next.js 14.2.5

   Creating an optimized production build ...
(node:50071) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
(node:50120) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
 âœ“ Compiled successfully
 âœ“ Linting and checking validity of types
 âœ“ Collecting page data
 âœ“ Generating static pages (5/5)
 âœ“ Collecting build traces
 âœ“ Finalizing page optimization

Route (app)                              Size     First Load JS
â”Œ â—‹ /                                    5.23 kB        92.3 kB
â”” â—‹ /_not-found                          875 B          87.9 kB
+ First Load JS shared by all            87 kB
  â”œ chunks/23-b75664ace61c0abb.js        31.5 kB
  â”œ chunks/fd9d1056-2821b0f0cabcd8bd.js  53.7 kB
  â”” other shared chunks (total)          1.85 kB


â—‹  (Static)  prerendered as static content


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OpenNext â€” Generating bundle â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Bundling middleware function...
Bundling static assets...
Bundling cache assets...
Building server function: default...
# copyPackageTemplateFiles
âš™ï¸ Bundling the OpenNext server...

# patchWranglerDeps
# updateWebpackChunksFile
 - chunk 347.js
 - chunk 682.js
 - chunk 948.js
Applying code patches:
 - patching require
 - patching `buildId` function
 - patching `loadManifest` function
 - patching next's require
 - patching `findDir` function
 - patching `evalManifest` function
 - patching cacheHandler
 - patching 'require(this.middlewareManifestPath)'
 - patching exception bubbling
 - patching `loadInstrumentationModule` function
 - patching `patchAsyncStorage` call
 - patching `eval("require")` calls
 - patching `require.resolve` call
All 13 patches applied

Worker saved in `/private/tmp/my-next-app/.open-next/worker.js` ğŸš€

OpenNext build complete.

 â›…ï¸ wrangler 3.101.0
--------------------

ğŸŒ€ Building list of assets...
ğŸŒ€ Starting asset upload...
ğŸŒ€ Found 31 new or modified static assets to upload. Proceeding with upload...
+ /BUILD_ID
+ /_next/static/3IkHGSNZNy73_7lkbfk4L/_buildManifest.js
+ /_next/static/chunks/app/layout-cacac135ce820ae3.js
+ /next.svg
+ /_next/static/chunks/webpack-d0ceac4fb78a3613.js
+ /cnd-cgi/_next_cache/3IkHGSNZNy73_7lkbfk4L/_not-found.cache
+ /_next/static/media/26a46d62cd723877-s.woff2
+ /_next/static/media/55c55f0601d81cf3-s.woff2
+ /_next/static/media/6d93bde91c0c2823-s.woff2
+ /cnd-cgi/_next_cache/3IkHGSNZNy73_7lkbfk4L/favicon.ico.cache
+ /_next/static/chunks/fd9d1056-2821b0f0cabcd8bd.js
+ /_next/static/3IkHGSNZNy73_7lkbfk4L/_ssgManifest.js
+ /_next/static/chunks/pages/_error-1be831200e60c5c0.js
+ /_next/static/chunks/main-app-8cc085c9d52c8c97.js
+ /_next/static/chunks/app/_not-found/page-05886c10710171db.js
+ /_next/static/media/df0a9ae256c0569c-s.woff2
+ /_next/static/chunks/173-32f9ff9bdfb525b3.js
+ /_next/static/media/581909926a08bbc8-s.woff2
+ /favicon.ico
+ /_next/static/chunks/polyfills-78c92fac7aa8fdd8.js
+ /_next/static/chunks/23-b75664ace61c0abb.js
+ /_next/static/chunks/app/page-41ceab464b24ef75.js
+ /_next/static/chunks/pages/_app-6a626577ffa902a4.js
+ /vercel.svg
+ /cnd-cgi/_next_cache/3IkHGSNZNy73_7lkbfk4L/500.cache
+ /_next/static/media/97e0cb1ae144a2a9-s.woff2
+ /_next/static/css/f451d9dd0f2d5d98.css
+ /cnd-cgi/_next_cache/3IkHGSNZNy73_7lkbfk4L/index.cache
+ /_next/static/media/a34f9d1faa5f3315-s.p.woff2
+ /_next/static/chunks/main-c8553ba68b419844.js
+ /_next/static/chunks/framework-f66176bb897dc684.js
Uploaded 10 of 31 assets
Uploaded 20 of 31 assets
Uploaded 31 of 31 assets
âœ¨ Success! Uploaded 31 files (6.85 sec)

Total Upload: 5238.56 KiB / gzip: 1355.74 KiB
Worker Startup Time: 92 ms
Uploaded my-next-app (23.24 sec)
Deployed my-next-app triggers (0.90 sec)
  https://my-next-app.moutend.workers.dev
Current Version ID: 35c1e4fb-0e51-43ea-92ed-4da5154b8b41
```

:::

## ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹

Workersã§å‹•çš„ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã€å¤§å‰ãƒ»ä¸­å‰ãƒ»å°å‰ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¿”ã™ãŠã¿ãã˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚

å®Ÿè£…ã™ã‚‹ã®ã¯ä»¥ä¸‹ã®2ã¤ã§ã™ã€‚

- src/components/Omikuji.tsx
- src/app/omikuji/page.tsx

â€»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–æ™‚ã«ä½œæˆã•ã‚Œã‚‹tsconfig.jsonã«pathã®è¨­å®šãŒã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ä¸Šè¨˜2ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã ã‘ã§å‹•ä½œã—ã¾ã™ã€‚

### src/components/Omikuji.tsx

src/componentsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®å†…å®¹ã§Omikuji.tsxã‚’ä½œæˆã—ã¾ã™ã€‚

```tsx
export default function Omikuji() {
  const results = ['å¤§å‰', 'ä¸­å‰', 'å°å‰'];
  const randomIndex = Math.floor(Math.random() * results.length);
  const fortune = results[randomIndex];

  return (
    <div>
      <p>ã‚ãªãŸã®é‹å‹¢ã¯â€¦</p>
      <p style={{ fontSize: '2rem', fontWeight: 'bold' }}>{fortune}</p>
    </div>
  );
}
```

### src/app/omikuji/page.tsx

src/app/omikujiãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®å†…å®¹ã§page.tsxã‚’ä½œæˆã—ã¾ã™ã€‚

```tsx
import { unstable_noStore } from "next/cache";
import Omikuji from "@/components/Omikuji";

export default function OmikujiPage() {
  // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ãŠã¿ãã˜ã‚’å¼•ãã€‚
  // Cloudflare WorkersãŒNext.js v15ã«å¯¾å¿œã—ãŸã‚‰unstable_noStore()ã‹ã‚‰connection()ã«å¤‰æ›´ã™ã‚‹ã€‚
  // await connection();
  unstable_noStore();

  return (
    <main style={{ padding: '1rem' }}>
      <h1>2025å¹´ã®é‹å‹¢ã¯ï¼Ÿ</h1>
      <p>
        æ–°ã—ã„ä¸€å¹´ãŒå§‹ã¾ã‚Šã¾ã—ãŸã­ã€‚é‹å‹¢ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€è‰¯ã„ã‚¹ã‚¿ãƒ¼ãƒˆã‚’åˆ‡ã‚Šã¾ã—ã‚‡ã†ï¼
      </p>
      <Omikuji />
    </main>
  );
}
```

### å‹•ä½œç¢ºèª

ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚

```console
npm run deploy
```

ãã®å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã§`https://my-next-app.<your_name>.workers.dev/omikuji`ã‚’é–‹ãã¾ã™ã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã³ã«å¤§å‰ãƒ»ä¸­å‰ãƒ»å°å‰ãŒãƒ©ãƒ³ãƒ€ãƒ ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

## ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’åˆ©ç”¨ã™ã‚‹

Workersã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã¯`getCloudflareContext()`ã§å‚ç…§ã§ãã¾ã™ã€‚è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

- D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã€omikuji_historyãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®šç¾©ã™ã‚‹ã€‚
- ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®éƒ½åº¦ãƒ©ãƒ³ãƒ€ãƒ ã«å¤§å‰ãƒ»ä¸­å‰ãƒ»å°å‰ã‚’é¸ã¶ã€‚
    - çµæœã‚’omikuji-historyãƒ†ãƒ¼ãƒ–ãƒ«ã«INSERTã™ã‚‹ã€‚
    - ç›´è¿‘ã®10ä»¶ã‚’SELECTã™ã‚‹ã€‚
    - SELECTã—ãŸçµæœã‚’`<table>`å½¢å¼ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã™ã‚‹ã€‚

ãªãŠã€å®Ÿè£…ã«ã¯Drizzle ORMã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ç´ ã®D1ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã§èª­ã¿æ›¸ãã—ã¦ã‚‚æ§‹ã‚ãªã„ã®ã§ã™ãŒã€çµæœã‚’TypeScriptã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ã®ãŒæ‰‹é–“ãªã®ã§ORMã‚’åˆ©ç”¨ã—ã¾ã™ã€‚Drizzle ORMã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚‚å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

[Cloudflare D1ã§Drizzle ORMã‚’ä½¿ã† - Zenn](https://zenn.dev/moutend/articles/88beb607855a26)

### Drizzle ORMã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```console
npm i drizzle-orm dotenv
npm i -D drizzle-kit tsx
```

### drizzle.config.tsã‚’ä½œæˆã™ã‚‹

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã«`drizzle.config.ts`ã‚’ä½œæˆã—ã¾ã™ã€‚ä»¥ä¸‹ã®å†…å®¹ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```ts
import 'dotenv/config';
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
	out: './drizzle',
	schema: './src/db/schema.ts',
	dialect: 'sqlite',
	driver: 'd1-http',
	dbCredentials: {
		accountId: process.env.CLOUDFLARE_ACCOUNT_ID!,
		databaseId: process.env.CLOUDFLARE_DATABASE_ID!,
		token: process.env.CLOUDFLARE_D1_TOKEN!,
	},
});
```

### D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åå‰ã¯é©å½“ã§æ§‹ã„ã¾ã›ã‚“ã€‚

```console
npx wrangler d1 create my-database
```

### wrangler.tomlãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹

D1ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã®è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚

```toml
#:schema node_modules/wrangler/config-schema.json
name = "my-next-app"
main = ".open-next/worker.js"

compatibility_date = "2024-09-26"
compatibility_flags = ["nodejs_compat"]

# Minification helps to keep the Worker bundle size down and improve start up time.
minify = true

# Use the new Workers + Assets to host the static frontend files
assets = { directory = ".open-next/assets", binding = "ASSETS" }

# ã“ã“ã‹ã‚‰è¿½åŠ 

[[d1_databases]]
binding = "DB"
database_name = "my-database"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

### å‹å®šç¾©ã‚’ç”Ÿæˆã™ã‚‹

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```console
npm run cf-typegen
```

### .envã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã«`.env`ã‚’é…ç½®ã—ã¾ã™ã€‚ä»¥ä¸‹ã®å†…å®¹ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```text
CLOUDFLARE_ACCOUNT_ID='Cloudflareã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID'
CLOUDFLARE_DATABASE_ID='wrangler.tomlãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®šã—ãŸdatabase_id'
CLOUDFLARE_D1_TOKEN='Cloudflareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç™ºè¡Œã—ãŸAPIãƒˆãƒ¼ã‚¯ãƒ³'
```

### ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®šç¾©ã™ã‚‹

src/dbãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®å†…å®¹ã§src/db/schema.tsã‚’ä½œæˆã—ã¾ã™ã€‚

```ts
import { sqliteTable, int, text } from "drizzle-orm/sqlite-core";

export const omikujiHistoryTable = sqliteTable("omikuji_history", {
  id: int().primaryKey({ autoIncrement: true }),
  fortune: text().notNull(),
  createdAt: text("created_at").notNull(),
});
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```console
npx drizzle-kit generate
npx drizzle-kit migrate
```

### src/app/d1/page.tsxã‚’å®Ÿè£…ã™ã‚‹

```tsx
import { unstable_noStore } from "next/cache";
import { getCloudflareContext } from "@opennextjs/cloudflare";
import { drizzle } from "drizzle-orm/d1";
import { desc } from "drizzle-orm";
import { omikujiHistoryTable } from "@/db/schema";

async function insert(env: CloudflareEnv, fortune: string) {
  const db = drizzle(env.DB);
  const record: typeof omikujiHistoryTable.$inferInsert = {
    fortune,
    createdAt: new Date().toISOString(),
  };

  await db.insert(omikujiHistoryTable).values(record);
}

async function select(
  env: CloudflareEnv,
): Promise<(typeof omikujiHistoryTable.$inferSelect)[]> {
  const db = drizzle(env.DB);
  const result = await db
    .select()
    .from(omikujiHistoryTable)
    .orderBy(desc(omikujiHistoryTable.id))
    .limit(10);

  return result;
}

export default async function Page() {
  unstable_noStore();

  const results = ["å¤§å‰", "ä¸­å‰", "å°å‰"];
  const randomIndex = Math.floor(Math.random() * results.length);
  const fortune = results[randomIndex];

  const { env } = await getCloudflareContext();
  await insert(env, fortune);
  const history = await select(env);

  return (
    <div>
      <h1>ãŠã¿ãã˜ã®å±¥æ­´</h1>
      <table border={1}>
        <thead>
          <tr>
            <th>ID</th>
            <th>Fortune</th>
            <th>Created At</th>
          </tr>
        </thead>
        <tbody>
          {history.map((record) => (
            <tr key={record.id}>
              <td>{record.id}</td>
              <td>{record.fortune}</td>
              <td>{new Date(record.createdAt).toLocaleString()}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
```

### å‹•ä½œç¢ºèª

ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚

```console
npm run deploy
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§`https://my-next-app.<your_name>workers.dev/d1`ã‚’é–‹ãã¨ãŠã¿ãã˜ã®å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ä½•åº¦ã‹ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ç›´è¿‘10ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå–å¾—ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºã‹ã‚ã¦ã¿ã¦ãã ã•ã„ã€‚

## ãŠã‚ã‚Šã«

è»½ãè©¦ã™ç¨‹åº¦ã§ã‚ã‚Œã°ç‰¹ã«ä¸å…·åˆãªãå®Ÿè£…ã§ãã¾ã—ãŸã€‚ãŸã ã—ã€ç¾æ™‚ç‚¹ã§ã¯å®Ÿé¨“çš„æ©Ÿèƒ½ã®æ‰±ã„ã§ã™ã€‚æœ¬ç•ªç’°å¢ƒã§åˆ©ç”¨ã™ã‚‹ã«ã¯ã—ã°ã‚‰ãæ§˜å­è¦‹ã§ã™ã­ã€‚

## å‚è€ƒè³‡æ–™

1. [Next.js Â· Cloudflare Workers docs](https://developers.cloudflare.com/workers/frameworks/framework-guides/nextjs/)
2. [Get Started - OpenNext](https://opennext.js.org/cloudflare/get-started)
3. [Bindings - OpenNext](https://opennext.js.org/cloudflare/bindings)
