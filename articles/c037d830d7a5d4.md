---
title: "[Swift] DispatchSourceã‚’åˆ©ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆãƒ»åå‰å¤‰æ›´ãƒ»å‰Šé™¤ã‚’ç›£è¦–ã™ã‚‹"
emoji: "ğŸŒŸ"
type: "tech"
topics: [Swift SwiftUI DispatchSource DispatchSourceFileSystemObject FileManager]
published: true
---
# ã¯ã˜ã‚ã«

ä»¥ä¸‹ã®ç’°å¢ƒã§å‹•ä½œç¢ºèªã—ã¾ã—ãŸã€‚

- Xcode 13.2.1 (13C100)
- iOS 15.1

# å®Ÿè£…ä¾‹

DispatchSourceã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆãƒ»åå‰å¤‰æ›´ãƒ»å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–ã§ãã¾ã™ã€‚ã“ã“ã§ã¯ä¾‹ã¨ã—ã¦Documentsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒ»åå‰å¤‰æ›´ãƒ»å‰Šé™¤ã‚’ç›£è¦–ã™ã‚‹å®Ÿè£…ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚

å®Ÿè£…ä¾‹ã¯SwiftUIã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚Xcodeã‚’é–‹ã„ã¦æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ãŸã‚‰ã€ContentView.swiftã‚’ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚

```swift
import SwiftUI

protocol FileWatcherDelegate {
  var targetURL: URL { get }
  func onChange()
  func onCancel()
}

class FileWatcher {
  var delegate: FileWatcherDelegate? = nil

  private let queue = DispatchQueue.global(qos: .default)

  private var fileDescriptor: Int32 = -1
  private var source: DispatchSourceFileSystemObject? = nil

  deinit {
    self.stop()
  }
  func stop() {
    if self.source != nil {
      self.source!.cancel()
      self.source = nil
    }
    if self.fileDescriptor < 0 {
      close(self.fileDescriptor)
      self.fileDescriptor = -1
    }
  }
  func start() {
    if self.source != nil {
      return
    }
    guard let url = self.delegate?.targetURL else {
      fatalError("failed to read url property")
    }

    let fileDescriptor = open(url.path, O_EVTONLY)
    let source = DispatchSource.makeFileSystemObjectSource(
      fileDescriptor: fileDescriptor, eventMask: .write, queue: self.queue)

    source.setEventHandler {
      if self.delegate != nil {
        self.delegate!.onChange()
      }
    }
    source.setCancelHandler {
      if self.delegate != nil {
        self.delegate!.onCancel()
      }
    }
    if self.delegate != nil {
      self.delegate!.onChange()
    }

    source.activate()

    self.fileDescriptor = fileDescriptor
    self.source = source
  }
}

class FileList: ObservableObject, FileWatcherDelegate {
  @Published var urls: [URL] = []

  var targetURL = URL(fileURLWithPath: NSTemporaryDirectory())

  func onChange() {
    guard
      let urls =
        try? FileManager.default.contentsOfDirectory(
          at: self.targetURL, includingPropertiesForKeys: nil,
          options: .skipsSubdirectoryDescendants)
    else {
      return
    }

    DispatchQueue.main.async {
      self.urls = urls
    }
  }
  func onCancel() {
    DispatchQueue.main.async {
      self.urls = []
    }
  }
}

extension URL: Identifiable {
  public var id: String {
    return self.absoluteString
  }
}

struct ContentView: View {
  @ObservedObject var fileList = FileList()

  let watcher = FileWatcher()

  var body: some View {
    VStack {
      List(self.fileList.urls) { url in
        Text(url.lastPathComponent)
      }
      Spacer()
      HStack {
        Button("Start") {
          self.watcher.start()
        }
        Button("Stop") {
          self.watcher.stop()
        }
        Button("Create") {
          self.create()
        }
        Button("Remove") {
          self.remove()
        }
      }
    }
  }
  init() {
    guard
      let documentURL = FileManager.default.urls(for: .documentDirectory, in: .userDomainMask).first
    else {
      fatalError("failed to get Document URL")
    }

    self.fileList.targetURL = documentURL
    self.watcher.delegate = self.fileList
  }
  func create() {
    let text = "Hello, World!"
    let n = Int.random(in: 0..<1_000_000)
    let name = "text-\(n).txt"
    let url = self.fileList.targetURL.appendingPathComponent(name)

    do {
      try text.write(to: url, atomically: true, encoding: .utf8)
    } catch {
      fatalError("failed to create file: \(url): \(error)")
    }
  }
  func remove() {
    for url in self.fileList.urls {
      do {
        try FileManager.default.removeItem(at: url)
      } catch {
        fatalError("failed to remove: \(error)")
      }
    }
  }
}

struct ContentView_Previews: PreviewProvider {
  static var previews: some View {
    ContentView()
  }
}
```

å®Ÿè£…ã®è‚ã¯`DispatchSource.makeFileSystemObjectSource(fileDescriptor: fileDescriptor, eventMask: .write, queue: self.queue)`ã§ã™ã€‚

ã¾ãšã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚¿ã«ã¯`open("/path/to/file", O_EVTONLY)`ã§å–å¾—ã—ãŸå€¤ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚iOS 14ä»¥é™ã§ã‚ã‚Œã°Cã®opené–¢æ•°ã§ã¯ãªãFileDescriptorå‹ã‚’åˆ©ç”¨ã—ã¦å®Ÿè£…ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹ã‚¯ã«ã¤ã„ã¦ã¯`.write`ã¨ã„ã†åå‰ã«åã—ã¦ä½œæˆã ã‘ã§ã¯ãªãåå‰ã®å¤‰æ›´ã‚„å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆã‚‚ç›£è¦–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚è©³ã—ãã¯DispatchSourceã®APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

# è©¦é‹è»¢

å®Ÿè£…ã—ãŸã‚¢ãƒ—ãƒªã®ä½¿ã„æ–¹ã‚’èª¬æ˜ã—ã¾ã™ã€‚

- ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€è¦§ã¯ç”»é¢ã®ä¸ŠåŠåˆ†ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
- Startãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ç›£è¦–ãŒå§‹ã¾ã‚Šã¾ã™ã€‚
- Createãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ãƒ©ãƒ³ãƒ€ãƒ ãªåå‰ã®`*.txt`ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
- Removeãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ç›£è¦–å¯¾è±¡ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚
- Stopãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ç›£è¦–ãŒçµ‚ã‚Šã¾ã™ã€‚

ã‚¢ãƒ—ãƒªãŒèµ·å‹•ã—ãŸã‚‰ã€ã¾ãšã¯Startãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚ãã®å¾Œã€Createãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã‚‹ã¨åŒæ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚

ã•ã‚‰ã«ã€iOSçµ„ã¿è¾¼ã¿ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰å¤‰æ›´ã‚„å‰Šé™¤ã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒ—ãƒªã®å¤‰æ›´ãŒå³åº§ã«åæ˜ ã•ã‚Œã¾ã™ã€‚

ãªãŠã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‹ã‚‰ã‚¢ãƒ—ãƒªå†…ã®Documentsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå‚ç…§ã§ãã‚‹ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ã«ã¯Info.plistã®è¨­å®šãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’ã”è¦§ãã ã•ã„ã€‚

- [Swiftã‚¢ãƒ—ãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿æ›¸ã | ã‚«ãƒ”é€šä¿¡](https://capibara1969.com/2836/)

# å‚è€ƒè³‡æ–™

1. [Detecting changes to a folder in iOS using Swift](https://medium.com/over-engineering/monitoring-a-folder-for-changes-in-ios-dc3f8614f902)
2. [DispatchSource: Detecting changes in files and folders in Swift](https://swiftrocks.com/dispatchsource-detecting-changes-in-files-and-folders-in-swift.html)
3. [How to detect changes in Documentsâ€¦ | Apple Developer Forums](https://developer.apple.com/forums/thread/90531)
