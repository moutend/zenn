---
title: "ï¼ˆSwiftï¼‰AVAudioFileã‚’åˆ©ç”¨ã—ã¦wavå½¢å¼ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹"
emoji: "ðŸ‘Œ"
type: "tech"
topics: [Swift, AVFoundation, AVAudioFile, éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«]
published: true
---
## å®Ÿè£…ä¾‹

ä¾‹ã¨ã—ã¦ã€`/tmp/input.wav`ã‚’èª­ã¿è¾¼ã¿ã€åŒã˜å†…å®¹ã‚’`/tmp/output.wav`ã¨ã—ã¦ä¿å­˜ã™ã‚‹å‡¦ç†ã‚’ç¤ºã—ã¾ã™ã€‚

```swift
import AVFoundation

func readPCMBuffer(url: URL) -> AVAudioPCMBuffer? {
    guard let input = try? AVAudioFile(forReading: url, commonFormat: .pcmFormatInt16, interleaved: false) else {
        return nil
    }
    guard let buffer = AVAudioPCMBuffer(pcmFormat: input.processingFormat, frameCapacity: AVAudioFrameCount(input.length)) else {
        return nil
    }
    do {
        try input.read(into: buffer)
    } catch {
        return nil
    }

    return buffer
}

func writePCMBuffer(url: URL, buffer: AVAudioPCMBuffer) throws {
    let settings: [String: Any] = [
        AVFormatIDKey: buffer.format.settings[AVFormatIDKey] ?? kAudioFormatLinearPCM,
        AVNumberOfChannelsKey: buffer.format.settings[AVNumberOfChannelsKey] ?? 2,
        AVSampleRateKey: buffer.format.settings[AVSampleRateKey] ?? 44100,
        AVLinearPCMBitDepthKey: buffer.format.settings[AVLinearPCMBitDepthKey] ?? 16
    ]

    do {
        let output = try AVAudioFile(forWriting: url, settings: settings, commonFormat: .pcmFormatInt16, interleaved: false)
        try output.write(from: buffer)
    } catch {
        throw error
    }
}

func copyPCMBuffer(from inputPath: String, to outputPath: String) {
    guard let inputBuffer = readPCMBuffer(url: URL(string: inputPath)!) else {
        fatalError("failed to read \(inputPath)")
    }
    guard let outputBuffer = AVAudioPCMBuffer(pcmFormat: inputBuffer.format, frameCapacity: inputBuffer.frameLength) else {
        fatalError("failed to create a buffer for writing")
    }
    guard let inputInt16ChannelData = inputBuffer.int16ChannelData else {
        fatalError("failed to obtain underlying input buffer")
    }
    guard let outputInt16ChannelData = outputBuffer.int16ChannelData else {
        fatalError("failed to obtain underlying output buffer")
    }
    for channel in 0 ..< Int(inputBuffer.format.channelCount) {
        let p1: UnsafeMutablePointer<Int16> = inputInt16ChannelData[channel]
        let p2: UnsafeMutablePointer<Int16> = outputInt16ChannelData[channel]

        for i in 0 ..< Int(inputBuffer.frameLength) {
            p2[i] = p1[i]
        }
    }

    outputBuffer.frameLength = inputBuffer.frameLength

    do {
        try writePCMBuffer(url: URL(string: outputPath)!, buffer: outputBuffer)
    } catch {
        fatalError("failed to write \(outputPath)")
    }
}

copyPCMBuffer(from: "file:///tmp/input.wav", to: "file:///tmp/output.wav")
```

## å®Ÿè£…ã®æ³¨æ„ç‚¹

ä»¥ä¸‹ã®2ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

1. AVAudioFileã®settingså¼•æ•°ï¼ˆå®Ÿè£…ä¾‹ã®28è¡Œç›®ï¼‰
1. æ›¸ãè¾¼ã¿ç”¨ãƒãƒƒãƒ•ã‚¡ã®frameLengthï¼ˆå®Ÿè£…ä¾‹ã®57è¡Œç›®ï¼‰

1.ã«ã¤ã„ã¦ã€WAVå½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã‚€å ´åˆã¯å°‘ãªãã¨ã‚‚ä»¥ä¸‹ã®4ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™ã€‚

- AVFormatIDKey
- AVNumberOfChannelsKey
- AVSampleRateKey
- AVLinearPCMBitDepthKey

ãªãŠã€settingsãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦`buffer.format.settings`ã‚’ãã®ã¾ã¾ä½¿ã†ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€å®Ÿè¡Œæ™‚ã«è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚AVAudioFileã®interleavedå¼•æ•°ã¨`buffer.format.settings[AVLinearPCMIsNonInterleaved]`ã®å€¤ãŒè¡çªã™ã‚‹ãŸã‚ã§ã™ã€‚

2.ã«ã¤ã„ã¦ã¯ãƒãƒƒãƒ•ã‚¡ã«æ›¸ãè¾¼ã‚“ã ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚è¨­å®šã‚’å¿˜ã‚ŒãŸå ´åˆã€ã™ãªã‚ã¡frameLengthãŒ0ã®å ´åˆã¯ç©ºã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

ä»Šå¾Œã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ä¿®æ­£ã•ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ç¾çŠ¶ã¯ãƒãƒƒãƒ•ã‚¡ã®frameLengthãŒ0ã§ã‚‚æ›¸ãè¾¼ã¿ã¯æˆåŠŸã—ã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼ã¯ç™ºç”Ÿã—ãªã„ãŸã‚æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

## å‚è€ƒæ–‡çŒ®

- [Audio Data Format Identifiers - Apple Developer](https://developer.apple.com/documentation/coreaudiotypes/coreaudiotype_constants/1572096-audio_data_format_identifiers)
