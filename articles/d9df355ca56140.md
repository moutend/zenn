---
title: "macOSのSafariで任意のWeb APIに接続できない状況を擬似的に再現する方法"
emoji: "🐡"
type: "tech"
topics: [macOS Safari]
published: false
---
# はじめに

記事の投稿にあたり、以下の環境で動作検証を行いました。

- macOS Monterey 12.6.3
- Safari 16.3

# 要件

以下のWebサイトがあると仮定します。

- 普段は`https://example.com/api/v2/`（プライマリAPI）を呼び出している。
- システム障害など何らかの理由でプライマリAPIに接続できない場合は`https://api.example.net/v1/`（セカンダリAPI）を呼び出す。
- プライマリAPIとセカンダリAPIどちらも接続できない場合は障害告知のtwitterフィードを表示する。

これを踏まえて以下の要件を満たす方法を考えます。

- 2パターンの状況を再現したい。
  1. プライマリAPIのみ接続できない
  2. プライマリAPIとセカンダリAPIどちらも接続できない
- デプロイされているHTMLやJavaScriptに手を加えてはならない。
- 500 Internal Server Errorを返したりコネクションのタイムアウトを再現したりといったサーバー側の細かな制御は不要。
- あくまでJavaScriptの`fetch()`や`xhr()`が失敗する状況を再現できればよい。
- `https://example.com/api/*`のように接続できない範囲をワイルドカードで指定したい。

# 実現方法

macOSあるいはSafariの標準機能でURLにもとづいたアクセス制限が実現できればよいのですが、今回の要件を満たせる機能は見つかりませんでした。ということでSafari Web Extensionを作ります。

Safari Web Extensionといっても大袈裟なものではなく、この後に示すのは10行にも満たないコードです。詳しいSafari Web Extensionの作り方については以下の記事で説明しています。

後ほど余談として今回の要件を実現するのに検討した方法を紹介します。

# （余談）検討した方法

要件を満たす方法をいくつか検討しました。それぞれ見送った理由を説明します。

## （案1）macOSのペアレンタルコントロール

macOSには標準機能としてペアレンタルコントロールが搭載されています。この機能を利用すれば特定のWebサイトへのアクセスを制限できます。

しかし、制限の方法が許可リスト方式でした。また、私が調べた限りワイルドカードは利用できないようでした。つまり、`https://example.com/api/*`を遮断するにはそのパスを除外してリクエストされる可能性のあるパスをすべて設定する必要があります。

さらに、HTTPリクエストのリファラが許可したWebサイトと一致する場合、そのリクエストは遮断できませんでした。例えば`https://example.com`を許可したとします。そのWebサイトから`https://fonts.googleapis.com/css`を参照している場合、そのリクエストは遮断できませんでした。
はきょかされてへのリクエストは許可されてしまいます。
他にも厄介な挙動をします。SafariのプライベートモードはWebサイト固有のデータが永続化されないので、例えばCookieの挙動を確認する際に便利です。しかし、アクセス制限を有効にするとSafariのプライベートモードが利用できません。毎回手作業で設定を開いてCookieを削除する必要が生じます。

## SafariのLocal Overrides

## WiFiルーターのアクセス制限機能

# 参考資料

1. [Blocking content with your Safari web extension | Apple Developer Documentation](https://developer.apple.com/documentation/safariservices/safari_web_extensions/blocking_content_with_your_safari_web_extension)
2. [chrome.declarativeNetRequest - Chrome Developers](https://developer.chrome.com/docs/extensions/reference/declarativeNetRequest/#type-RuleCondition)
3. [](https://github.com/requestly/modify-headers-manifest-v3)
