---
title: "Cloudflare Workers入門"
emoji: "🙆"
type: "tech"
topics: [Cloudflare JavaScript TypeScript V8]
published: false
---
## はじめに

この記事はCloudflare Workersの入門記事です。

- 「Cloudflare Workersはサーバーレス・エッジコンピューティングサービスだよ」と説明されて日本語でOKと感じている方
- AWSのLambdaやGCPのCloud Runと似たようなサービスだろうと認識されている方
- そもそもCloudflare Workersが何者なのか知らない方

上記いずれかに当てはまる方のお役に立てるはずです。

なお記事を読み進める上で必須ではありませんが、JavaScriptあるいはTypeScriptの読み書きができるとスムーズに理解できるかと思います。

## 環境構築

記事を読み進めるために、まずは環境構築を行いましょう。といっても、最新のnode.jsをインストールするだけです。インストールできたらバージョンを確認しておきましょう。

```console
$ node --version
v19.6.0
```

**補足事項**

- v16.13.0より新しいバージョンが必要になります。記事を読み進めて不具合に遭遇したときはnode.jsのバージョンを確認してください。
- Windowsでの動作検証はしていません。ここから先の手順については問題なく動作するはずですが、もし不具合に遭遇した場合はWSLなどのLinux環境を利用してください。

## サインアップ

早速Cloudflare Workersを使ってみましょう。なんと完全無料で利用できるFreeプランが用意されています。太っ腹ですね。

もちろんクレジットカードの登録は不要です。気づかない間に課金されてクラウド破産することはありません。ご安心ください。

トップページのSign upをクリックしてサインアップを行いましょう。リンクは以下になります。

- [Cloudflare Workers®](https://workers.cloudflare.com)

余談になりますが、Freeプランは性能面でいくつか制限があります。もしCloudflare Workersを気に入ったら有料プランを検討してみてください。性能面の違いと料金体系については以下のページにまとめられています。

- [Limits - Cloudflare Workers docs](https://developers.cloudflare.com/workers/platform/limits/#worker-limits)
- [Pricing - Cloudflare Workers docs](https://developers.cloudflare.com/workers/platform/pricing/)

## サブドメインの設定

サインアップが完了したらcloudflare.comを開いてLoginをクリックしてください。ログインが成功するとダッシュボードが表示されます。

Cloudflare Workersはプロジェクトごとに`https://プロジェクト名.サブドメイン.workers.dev`を発行してくれます；。サブドメインは自由に設定できます。

ダッシュボードの「Workers」をクリックするとサブドメインの入力が求められます。お好みのサブドメインを設定してください。

ここから先はサブドメインとして`example`を設定したものと仮定して説明を進めます。

## wrangler

続いてwranglerのインストールとセットアップを行います。wranglerはCloudflare Workersを操作するためのCLIツールです。

もちろんCloudflare Workersはダッシュボードから操作できます。しかし、ダッシュボードの見た目は今後変更されるかもしれません。そうするとスクリーンショットを貼り付けた説明では混乱が生じる恐れがあります。

そこで、wranglerを利用して説明することにします。一度コマンドを覚えれば作業効率もアップします。

### インストール

以下のコマンドを実行してください。

```console
$ npm install -g wrangler
```

インストールが終わったら、以下のコマンドを実行してください。バージョンが表示されたらインストールは成功です。

```console
$ npx wrangler --version
 ⛅️ wrangler 2.14.0
```

### セットアップ

インストールしただけでは使えません。wranglerを使うには認証が必要です。

まずは`npx wrangler login`を実行してください。実行令を以下に示します。

```console
$ npx wrangler login
 ⛅️ wrangler 2.14.0
--------------------
Attempting to login via OAuth...
Opening a link in your default browser: https://dash.cloudflare.com/oauth2/auth?response_type=code&client_id=...
```

上記のメッセージが表示されると同時にブラウザが起動しますので、Allowボタンをクリックしてください。

認証が成功すると「Successfully logged in.」というメッセージが表示されます。

```console
$ npx wrangler login
 ⛅️ wrangler 2.14.0
--------------------
Attempting to login via OAuth...
Opening a link in your default browser: https://dash.cloudflare.com/oauth2/auth?response_type=code&client_id=...
Successfully logged in.
```

## Hello, World!

Cloudflare Workersを利用する準備は整いました。定番の「Hello, World!」をしましょう。

### プロジェクトの初期化

まずはプロジェクトの初期化を行いましょう。ここではプロジェクト名として`hello`を設定することにします。以下のコマンドを実行してください。

```console
$ npx wrangler init hello
```

初期化の際にいくつか質問されます。今回は以下のように答えました。

- gitで管理しますか？ → no
- TypeScriptを使いますか？ → yes
- Vitestのテストを作成しますか？ → no

今回はサンプルということでgitの管理とテストコードの生成は外しました。また、TypeScriptは必須ではありません。説明を進める上で都合が良いためTypeScriptを選んだだけです。

参考までに実行例を示します。初期化が成功すると`hello`ディレクトリが生成されます。

```console
$ npx wrangler init hello
 ⛅️ wrangler 2.14.0
-------------------------------------------------------
Using npm as package manager.
✨ Created hello/wrangler.toml
✔ Would you like to use git to manage this Worker? … no
✔ No package.json found. Would you like to create one? … yes
✨ Created hello/package.json
✔ Would you like to use TypeScript? … yes
✨ Created hello/tsconfig.json
✔ Would you like to create a Worker at hello/src/index.ts? › Fetch handler
✨ Created hello/src/index.ts
✔ Would you like us to write your first test with Vitest? … no
(⠂⠂⠂⠂⠂⠂⠂⠂⠂⠂⠂⠂⠂⠂⠂⠂⠂⠂) ⠋ idealTree:hello: sill idealTree buildDeps
npm WARN deprecated rollup-plugin-inject@3.0.2: This package has been deprecated and is no longer maintained. Please use @rollup/plugin-inject.
npm WARN deprecated sourcemap-codec@1.4.8: Please use @jridgewell/sourcemap-codec instead

added 104 packages, and audited 105 packages in 20s

12 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities
✨ Installed @cloudflare/workers-types and typescript into devDependencies

To start developing your Worker, run `cd hello && npm start`
To publish your Worker to the Internet, run `npm run deploy`
```

### Workerのエントリーポイント

生成されたコードを確認しましょう。お好みのエディタで`src/index.ts`を開いてください。

記事の執筆時点では以下のコードが生成されました。

```ts
/**
 * Welcome to Cloudflare Workers! This is your first worker.
 *
 * - Run `wrangler dev src/index.ts` in your terminal to start a development server
 * - Open a browser tab at http://localhost:8787/ to see your worker in action
 * - Run `wrangler publish src/index.ts --name my-worker` to publish your worker
 *
 * Learn more at https://developers.cloudflare.com/workers/
 */

export interface Env {
  // Example binding to KV. Learn more at https://developers.cloudflare.com/workers/runtime-apis/kv/
  // MY_KV_NAMESPACE: KVNamespace;
  //
  // Example binding to Durable Object. Learn more at https://developers.cloudflare.com/workers/runtime-apis/durable-objects/
  // MY_DURABLE_OBJECT: DurableObjectNamespace;
  //
  // Example binding to R2. Learn more at https://developers.cloudflare.com/workers/runtime-apis/r2/
  // MY_BUCKET: R2Bucket;
  //
  // Example binding to a Service. Learn more at https://developers.cloudflare.com/workers/runtime-apis/service-bindings/
  // MY_SERVICE: Fetcher;
}

export default {
  async fetch(
    request: Request,
    env: Env,
    ctx: ExecutionContext
  ): Promise<Response> {
    return new Response("Hello World!");
  },
};
```

### コードの解説

生成された`src/index.ts`について説明します。

まず、冒頭のコメントはWorkerの実行方法についての簡単な説明ですから読み飛ばしてください。このコメントは削除して構いません。

次は`Env`インターフェースの定義です。CloudflareはWorkersの他にも様々なサービスを提供しており、それらと連携する際に必要になります。発展的な内容になるため、ひとまず読み飛ばしましょう。

最後は関数定義です。ここが最も重要な部分です。`async fetch`と書かれている部分に注目してください。これがWorkerのエントリーポイントです。

### 処理の流れ

fetch関数で行われる処理の流れを説明します。

1. HTTPリクエストを受け取る
2. 何らかの処理を行う
3. HTTPレスポンスを返す

以上です。

大まかに言えば、Workerはfetch関数の実行単位です。Cloudflareのサーバーにリクエストが到着するとWorkerが作成されて、fetch関数が実行されます。fetch関数の実行が完了するとWorkerは削除されます。

そして、Cloudflare WorkersはWorkerのホスティングサービスです。自前でサーバー構築することなくサーバーサイドの処理を実装できるためサーバーレスとよばれています。

### 標準API

ここで改めてfetch関数の引数と戻り値に注目してください。RequestとResponseがあります。どちらもJavaScriptの標準APIで定義されているインターフェースです。

- [Request - Web APIs - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Request)
- [Response - Web APIs - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Response)

つまり、流れてきたバイナリを解析してHTTPヘッダーを抽出したり、HTTPレスポンスのContent-Lengthを計算したりする必要がないのです。便利ですね。

ただし、裏を返せばHTTPではない独自のプロトコルを扱うことはできませんし、ネットワークに近いレイヤーの処理を実装することもできません。将来的にCloudflare Workersの機能が拡張される可能性はゼロではありませんが、基本はHTTPを扱うサービスだと考えてください。

なおfetch関数には第3の引数`ctx: ExecutionContext`があります。こちらも`Env`インターフェースと同様に発展的な内容になるため、今回は説明をスキップします。

### 手元のマシンで動作確認する

お待たせしました。動作確認の時間です。まずは手元のマシンでWorkerを動かしてみましょう。

以下のコマンドを実行してください。

```console
$ npx wrangler dev
```

これで準備完了です。デフォルトでは`localhost:8787`でリクエストを待ち受けます。

それではcurlコマンドを使ってリクエストを投げてみましょう。以下のように表示されたら成功です。

```console
$ curl http://localhost:8787
Hello, World!
```

おめでとうございます！無事に「Hello, World!」が表示されました。

なお、レスポンスに改行文字「`\n`」を含めていないため、実際には「Hello, World!$ 」のようにプロンプトの文字「`$`」が続けて表示されるはずです。気になる方は`\n`を追加してください。

### インターネットに公開する

さぁ、おもしろいのはここからです。以下のコマンドを実行すると、Cloudflareのサーバー上でWorkerが実行されるようになります。

```console
$ npx wrangler publish
```

これでインターネット上からWorkerにアクセスできるようになりました。。以下のようにcurlコマンドを実行してみてください。

```console
$ curl https://hello.example.workers.dev
Hello, World!
```

素晴らしい！あなたのWorkerは世界のどこからでもアクセスできるようになりました。

## 利用例を考える

ここからはCloudflare Workersがどのような場面で利用できるか検討します。

### 処理の隠蔽

まず考えられるのが、処理の隠蔽です。例えば、以下のような処理をWorkerで実行するとします。

```ts
export interface Env {
  // ...
}

const omikuji = ["大吉", "中吉", "小吉"];

export default {
  async fetch(
    request: Request,
    env: Env,
    ctx: ExecutionContext
  ): Promise<Response> {
    const i = Math.floor(Math.random() * 3);

    return new Response(omikuji[i]);
  },
};
```

おみくじを実行するWorkerです。リクエストを投げるたびに異なるレスポンスが帰ってきます。参考までに実行例を示します。

```console
$ curl http://localhost:8787
中吉
```

難読化してもクライアントサイドのJavaScriptは解析される恐れがあります。そこで、解析されて困る処理をWorkerで実行することで処理を隠蔽します。

おみくじを例に考えましょう。

- どのような候補があるか？
- 候補の中から1つを選択するロジックはどのように実装されているか？

これらを隠蔽するのにCloudflare Workersは最適です。おみくじ程度であればクライアントサイドで処理を完結させることも可能ですが、解析を防ぐにはひと工夫が必要になります。

ただし、クライアントサイドで処理が完結する場合と比較するとインターネットを経由することになります。レイテンシーの発生は避けられません。

さらに、処理の結果が毎回異なる場合はキャッシュが効きません。クライアントサイドで処理が完結する場合、ブラウザのキャッシュにjsファイルが残っていればオフラインでも処理が続行できます。一方、Cloudflare Workersで処理する場合、インターネットへのアクセスが切断されると処理は続行できません。

### cfプロパティの参照

fetch関数の引数について、Requestインターフェースに注目してください。Requestインターフェースは標準APIを満たすと同時に、実はCloudflareが独自に定義したcfプロパティが追加されているのです。

cfプロパティの中で興味深いものをいくつかピックアップし、それをレスポンスとして返してみます。実装例を以下に示します。

```ts
```

実行すると以下のような結果が得られます。

```console
$ curl https://cf.example.workers.dev
```

## 衝撃の事実！？あなたのコードは世界デビューしていた

## 制限

```ts
export interface Env {
  // ...
}

async function sleep(milliSecond: number): Promise<string> {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      resolve("done");
    }, milliSecond);
  });
}

export default {
  async fetch(
    request: Request,
    env: Env,
    ctx: ExecutionContext
  ): Promise<Response> {
    const message = await sleep(5000);

    return new Response(message);
  },
};
```

## 次はどうする？

## 参考資料

1. [Building a To-Do List with Workers and KV - The Cloudflare Blog](https://blog.cloudflare.com/building-a-to-do-list-with-workers-and-kv/)
[Cloudflare Workers と KV でTodoListアプリを作る](https://zenn.dev/kameoncloud/articles/7236a2c6ad35c0)
1. [CloudflareにNode.jsのAsyncLocalStorageがサポートされたので試してみた - DevelopersIO](https://dev.classmethod.jp/articles/cloudflare-workers-asynclocalstorage/)
1. [Get started guide - Cloudflare Workers docs](https://developers.cloudflare.com/workers/get-started/guide/)
2. [How Workers works - Cloudflare Workers docs](https://developers.cloudflare.com/workers/learning/how-workers-works/)
3. [Request - Cloudflare Workers docs](https://developers.cloudflare.com/workers/runtime-apis/request/)
3. [Request - Web APIs - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Request)
4. [Cloudflare Global Network - Data Center Locations - Cloudflare](https://www.cloudflare.com/network/)
5. [IATA - Wikipedia](https://en.wikipedia.org/wiki/IATA_airport_code)
6. [Autonomous system - Wikipedia](https://en.wikipedia.org/wiki/Autonomous_system_(Internet))
- [Wrangler (command line) - Cloudflare Workers docs](https://developers.cloudflare.com/workers/wrangler/)
- [Install/Update Wrangler - Cloudflare Workers docs](https://developers.cloudflare.com/workers/wrangler/install-and-update/)
