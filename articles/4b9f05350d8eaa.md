---
title: "入門 Cloudflare Realtime -- WebRTC を利用したビデオ通話アプリの作り方"
emoji: "💬"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Cloudflare, WebRTC, JavaScript]
published: false
---
## はじめに

本記事ではブラウザで動作するビデオ通話アプリの実装方法を解説します。実装にあたってはSDKやフレームワークを利用せず、素のJavaScriptで実装します。  
対象読者はWebRTCに触れた経験のない方です。必要な知識は都度説明するため、記事の冒頭から順を追って読み進めてください。すでに理解されている項目については読み飛ばして構いません。  
本記事で実装するビデオ通話アプリはSTUN / TURN / SFUとしてCloudflare Realtimeを利用します。用語については後ほど解説しますのでご安心ください。  

## Cloudflare Realtimeとは

Cloudflare Realtimeはビデオ通話などのリアルタイム通信機能を実現するサービスです。以前はCloudflare Callsとよばれていましたが、2025年4月に正式リリースされると同時にサービス名が変更されました。

**リリースブログ**

- [（原文）Make your apps truly interactive with Cloudflare Realtime and RealtimeKit - The Cloudflare Blog](https://blog.cloudflare.com/introducing-cloudflare-realtime-and-realtimekit/)
- [（翻訳）Cloudflare RealtimeとRealtimeKitでアプリを本当の意味でインタラクティブに - The Cloudflare Blog](https://www.google.com/search?client=safari&rls=en&q=cloudflare+realtime+release&ie=UTF-8&oe=UTF-8)。

リリースブログで言及されているRealtimeKit SDKについては本記事を投稿した時点で非公開ベータ版です。一般には提供されていません。また、本記事ではRealtimeKit SDKについての解説は行いません。

### 公式デモアプリ「Orange Meets」について

Cloudflare Realtimeを試すには公式のデモアプリ「Orange Meets」が最もお手軽です。以下のURLからアクセスできます。  

https://demo.orange.cloudflare.dev
Orange MeetsはWebアプリケーションとしてCloudflare Workers上にデプロイされています。Cloudflare Realtimeを含め、完全にCloudflareスタックで構築されているのが特徴です。
ソースコードについては以下のリポジトリで公開されています。  

https://github.com/cloudflare/orange
ただし、Orange Meetsはデモアプリとしてはかなり高機能で細部まで作り込まれています。おそらく、初見ではどこまでがCloudflare Realtimeの機能で、どこからがアプリ独自の機能なのか判断できないはずです。  
お急ぎの方のために説明すると、Cloudflare Realtime自体に以下の機能はありません。  

- ルーム機能
- ユーザー認証機能
- ビデオ通話の背景ノイズキャンセル機能

Cloudflare Realtimeは良くも悪くも素朴なサービスです。Cloudflare Realtimeが提供するのはリアルタイム通信を実現するための基礎となる部品にすぎません。  
その点はCloudflareも承知しているため、より手軽にCloudflare Realtimeを活用できるSDKとしてRealtimeKitを開発しているわけです。今は手を出さず、RealtimeKitがリリースされるのを待っても良いかもしれません。  

### Cloudflare RealtimeはSTUN / TURN / SFUを提供するフルマネージドサービスである

「Cloudflare Realtimeはリアルタイム通信機能を実現するサービスである」そのように説明されても抽象的すぎます。具体的には、何を提供するのでしょうか。  
それでは具体的に説明しましょう。Cloudflare RealtimeはフルマネージドなSTUN / TURN / SFUサーバーを提供します。今度は具体的すぎたでしょうか。  
Cloudflare Realtimeが提供するサービスの利用方法を理解するにはWebRTCの知識が必要になります。まずはWebRTCの概要を把握しましょう。  

## WebRTCの概要

WebRTC（Web RealTime Communication）は双方向リアルタイム通信を実現するために策定されたAPIやプロトコルの集合です。技術仕様はRFCとして公開されています。  
ほとんどのブラウザに標準機能として搭載されているため、拡張機能やプラグインを追加することなく利用できるのがWebRTCの特徴です。また、Webとは名乗っていますが、その利用はブラウザだけに制限されません。プロトコルに従えばWebブラウザとモバイルアプリの間で通信する、といったことも可能です。  
WebRTCの技術仕様は多岐に渡り、仕様を網羅的に理解するのは困難です。[^1]本記事ではCloudflare Realtimeを利用するために必要となる知識に絞ってWebRTCの基礎を説明します。  

[^1]: WebRTCについての素晴らしい解説記事を見つけた、と思ったら途中で力尽きていました。WebRTC完全理解への道は険しいようです。 https://zenn.dev/yuki_uchida/books/c0946d19352af5/viewer/0e7daa

### WebRTCはP2Pプロトコルである

WebRTCはサーバーを経由せず通信するプロトコルです。通信に参加する者をピアとよび、ピア同士で直接通信する方式をP2P（peer-to-peer）とよびます。  
ただし、通信の際に全くサーバーを利用しないわけではありません。以降で補足します。  

### STUNとは

P2P通信を実現するためには、各ピアが自身の「インターネット上で特定可能な住所」、つまりグローバルIPアドレスとポート番号を知る必要があります。しかし、多くのデバイスはルーターやファイアウォールの内側にあり、プライベートIPアドレスしか持っていません。このような環境をNAT（Network Address Translation）環境と呼びます。  
STUN（Session Traversal Utilities for NAT）は、NAT問題を解決するためのプロトコルです。ピアはインターネット上にあるSTUNサーバーに問い合わせることで、自身がNATの内側にある場合でも、NATデバイスが割り当てたグローバルIPアドレスとポート番号（NAT外部アドレス）を知ることができます。この情報を相手ピアに伝えることで、P2P通信の確立を試みます。  
ただし、NATの種類によってはSTUNだけではP2P接続を確立できないケースも存在します。  

### TURNとは

STUNを利用してもP2P接続が確立できない場合に活躍するのがTURN（Traversal Using Relays around NAT）です。TURNは、NAT越えが困難な状況下でピア間の通信を中継するプロトコルです。  
具体的には、各ピアはTURNサーバーに対してメディアデータ（音声や映像）を送信し、TURNサーバーがそのデータを相手ピアに転送します。これにより、P2Pで直接通信できないピア同士でも、TURNサーバーを介して間接的にリアルタイム通信を行うことができます。  
もちろん、通信がサーバーを経由するため、P2Pによる直接通信に比べて遅延が大きくなるデメリットがあります。しかし、どのようなネットワーク環境下でも安定した通信を保証するための最終手段としてTURNは欠かせません。  

### SFUとは

P2Pでビデオ通話を行う場合、参加者が増えるとその複雑さが指数関数的に増大します。例えば、3人でビデオ通話する場合、各ピアは他の2つのピアとそれぞれ接続を確立し、データを送受信する必要があります（合計3接続）。参加者が5人になると、各ピアは4つのピアと接続し、全体では10接続が必要になります。  

図 5人の参加者がメッシュ接続で通信する概念図

このように、参加者が増えるほど接続の管理が難しくなります。この接続方式をメッシュ接続と呼びます。  
SFU（Selective Forwarding Unit）は、多人数接続の課題を解決するための手段の一つです。接続の形態については下記の図のような形になります。  
SFUサーバーを利用する場合、各ピアはSFUサーバーとのみ接続を確立します。ピアは自身のメディアストリーム（音声や映像）をSFUサーバーに送信し、SFUサーバーがそのストリームを受信し、他の全てのピアに転送します。  

図 5人の参加者がSFUを中心としたスター形の接続で結ばれている概念図

SFUを介してピア同士で通信する場合、厳密にはP2Pとは言えないかもしれません。ただし、各ピアは唯一の通信相手であるSFUとP2Pで接続されているため、ピア視点ではP2Pであると見なすこともできます。  
なお、本記事で作成するビデオ通話アプリもSFUを利用します。  

### シグナリングとは

P2P通信を開始するためには、ピア同士が事前にいくつかの情報を交換する必要があります。この情報交換のプロセスをシグナリングとよびます。  
シグナリングは、いわば「これからビデオ通話を始めたいのだけど、あなたはどんな設定で話せる？私はこんな感じだよ」とお互いの情報を交換し、合意形成を行うための準備段階です。この準備が整って初めて、実際のメディアデータの送受信が開始されます。  
WebRTCの仕様はシグナリングの手段について規定しておらず、開発者が自由に実装方法を選択できます。一般的にはWebSocketやHTTPが利用されます。  

#### SDPとは

シグナリングで交換される情報の内、メディアに関連するものをSDP（Session Description Protocol）とよびます。具体的には次のような情報がSDPに含まれます。  

- 使用する音声や映像のコーデック
- 解像度やフレームレート
- 送信するメディアトラックの種類（音声のみ、映像のみ、音声と映像など）。

### ICE候補とは

ICE（Interactive Connectivity Establishment）候補は、ピアが通信に利用できる可能性のあるIPアドレスとポート番号の組み合わせです。STUNサーバーから取得したNAT外部アドレスや、TURNサーバーから取得したリレーアドレスなどが含まれます。  
「ICE」ではなく「ICE候補」とよばれているのは、通信が確実に成功するかは試してみるまでわからないからです。

### STUNとは

私たちが普段利用するデバイスは直接インターネットに接続しているわけではありません。多くの場合、通信経路の途中でNAT（Network Address Translator）を経由します。NATはインターネットとローカルなネットワークの中間に配置され、それぞれのネットワークに割り振られたアドレスを相互に変換します。
例えば、iPhoneの設定アプリを開いて設定→WiFi→詳細情報→IPv4アドレスを確認してみてください。おそらく、`192.168.xxx.xxx`というアドレスが割り振られているはずです。このアドレスはローカルなネットワークに割り振られたアドレスです。  
P2Pで通信を行うにはインターネット側に割り振られたアドレスを知る必要があります。そこで登場するのがSTUN（Session Traversal Utilities for NAT）サーバーです。STUNサーバーに問い合わせることで、インターネット側に割り振られたアドレスを知ることができます。  
Cloudflare Realtimeを構成する要素にはSTUNサーバーが含まれています。STUNサーバーはCloudflareが管理しているため、我々が管理する手間なく利用できます。  

:::details 5 tuplesとは

### 5 tuplesとは

WebRTCに限った話題ではありませんが、P2P通信の文脈では5 tuples（ファイブ・タプル）とよばれる項目があります。以下5つの要素で構成されます。  

- 送信元のIPアドレス
- 送信元のポート番号
- 送信先のIPアドレス
- 送信先のポート番号
- トランスポートプロトコル（UDPなど）

少なくとも、これら5つの情報が揃わなければP2Pで通信できません。WebRTCの文脈で5 tuplesについて言及している場合、上記の項目について言及しているのだと読み替えてください。  

:::

### TURNとは

### SFUとは

1. Aliceか利用可能な音声・映像コーデックをBobに伝える。
2. Bobが利用可能な音声・映像コーデックをAliceに伝える。
3. AliceとBobお互いが利用可能な最大公約数の音声・映像コーデックを使って通信を開始する。
### 費用について

費用は発生しません。後ほど詳しく説明しますが、本記事で利用するCloudflare Realtimeには毎月1,000 GBの無料データ転送量が含まれます。個人でビデオ通話アプリの動作確認をする程度であれば、この無料枠で十分に足ります。  

### 動作確認後のアプリ削除について

本記事で実装するビデオ通話アプリはあくまでサンプルです。ユーザー認証機能がありません。デプロイされたURLを知っている人であれば誰でも利用できます。  
また、今回の実装は動作の仕組みが理解できることを優先するため、Cloudflare Realtimeシークレットをクライアント側のJavaScriptに埋め込みます。本来、シークレットが漏洩するような方法で実装を行ってはいけません。  
従って、動作確認が終わった後にアプリを削除せず放置していると、意図せず利用されて課金される恐れがあります。手順については削除方法の章で説明しますので、指示に従ってください。  


## 参考文献

1. [Introduction to the Real-time Transport Protocol (RTP) - Web APIs - MDN](https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Intro_to_RTP)
