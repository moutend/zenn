---
title: "ï¼ˆå®Ÿè·µCloudflare Workersï¼‰Service bindingsã‚ã‚‹ã„ã¯Gateway Workerãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç´¹ä»‹"
emoji: "ğŸ—‚"
type: "tech"
topics: [Cloudflare, "Cloudflare Pages", "Cloudflare Workers"]
published: false
---
## ã¯ã˜ã‚ã«

Cloudflare Workersã«ã¯Bindingsï¼ˆãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼‰ã¨ã‚ˆã°ã‚Œã‚‹ä»•çµ„ã¿ãŒã‚ã‚Šã¾ã™ã€‚ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¨­å®šã™ã‚‹ã¨ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®R2ã‚„ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®D1ãªã©ã€CloudflareãŒæä¾›ã™ã‚‹åˆ¥ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’Workerã‹ã‚‰ç›´æ¥æ“ä½œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚Service bindingsã¯ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã®ä¸€ç¨®ã§ã‚ã‚Šã€WorkeråŒå£«ã§é€šä¿¡ã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ã§ã™ã€‚

ã‚‚ã¡ã‚ã‚“ã€Service bindingsã‚’ä½¿ã‚ãªãã¦ã‚‚é€šå¸¸ã®`fetch()`ã§WorkeråŒå¿—ã®é€šä¿¡ã¯è¡Œãˆã¾ã™ã€‚ã—ã‹ã—ã€ä»¥ä¸‹ã®å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚

1. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚’çµŒç”±ã—ãŸé€šä¿¡ã«ãªã‚‹ãŸã‚ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ãŒç”Ÿã˜ã‚‹ã€‚
2. éå…¬é–‹ã®WorkeråŒå£«ã§é€šä¿¡ã§ããªã„ã€‚
3. ã©ã®WorkeråŒå£«ãŒé€£æºã—ã¦ã„ã‚‹ã®ã‹Cloudflareã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä¸Šã§æŠŠæ¡ã§ããªã„ã€‚

ã“ã‚Œã‚‰ã®å•é¡Œã‚’è§£æ±ºã§ãã‚‹ã®ãŒService bindingsã§ã™ã€‚é€šä¿¡ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚’çµŒç”±ã›ãšCloudflareã®é–‰ã˜ã‚‰ã‚ŒãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…ã§å®Œçµã™ã‚‹ãŸã‚ã€é€šå¸¸ã®`fetch()`ã¨æ¯”è¼ƒã—ã¦ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã¯ç„¡è¦–ã§ãã‚‹ã»ã©å°ã•ããªã‚Šã¾ã™ã€‚ã¾ãŸã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚’çµŒç”±ã—ãªã„ãŸã‚éå…¬é–‹ã®WorkeråŒå£«ã§é€šä¿¡å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

ä»Šå›ã¯ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒ»ã‚¨ãƒƒã‚¸ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®è¦–ç‚¹ã§Service bindingsã®ç´¹ä»‹ã‚’ã—ã¾ã™ã€‚ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®JavaScriptãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚„CDNã‚’ã‹ã‚‰ã‚ãŸèª¬æ˜ã¯ã—ã¾ã›ã‚“ã®ã§ã€ãã®ç‚¹ã¯ã”ç•™æ„ãã ã•ã„ã€‚

## ç’°å¢ƒ

è¨˜äº‹ã®æŠ•ç¨¿ã«ã‚ãŸã‚Šã€ä»¥ä¸‹ã®ç’°å¢ƒã«ã¦å‹•ä½œç¢ºèªã‚’è¡Œã„ã¾ã—ãŸã€‚

- wranglerã‚³ãƒãƒ³ãƒ‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v3.1.2
- wrangler.tomlãƒ•ã‚¡ã‚¤ãƒ«ã®`compatibility_date`: 2023-06-28

Service bindingsã¯èª°ã§ã‚‚åˆ©ç”¨ã§ãã‚‹çŠ¶æ…‹ã§ã™ã€‚ãŸã ã—ã€ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸã®ãŒ2022å¹´11æœˆ31æ—¥ã§ã™ã€‚ã¾ã æ—¥ãŒæµ…ã„ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã®ã§ã€å¤§ããªå¤‰æ›´ãŒåŠ ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ„å›³ã—ãªã„æŒ™å‹•ã«é­é‡ã—ãŸå ´åˆã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## Workerã®ä½œæˆ

ãã‚Œã§ã¯ã€3ã¤ã®Workerã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚è¨˜äº‹ã®èª¬æ˜ã®ãŸã‚ã«è¦ªã—ã¿ã‚’è¾¼ã‚ãŸåå‰ã‚’ã¤ã‘ã¾ã—ãŸãŒã€æ·±ã„ç†ç”±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å„è‡ªã§ãŠå¥½ã¿ã®åå‰ã‚’ã¤ã‘ã¦ã„ãŸã ã„ã¦OKã§ã™ã€‚

1. ã‚Šã‚“ã”Worker
2. ãƒãƒŠãƒŠWorker
3. ã•ãã‚‰ã‚“ã¼Worker

ãã‚Œãã‚Œã®Workerã‚’ä½œæˆã™ã‚‹ã«ã¯`npm create cloudflare@latest`ã§Hello Workerãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚ãã®å¾Œã€`wrangler.toml`ã¨`src/worker.ts`ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚

### ã‚Šã‚“ã”Workerã®æ¦‚è¦

ã‚Šã‚“ã”Workerã®æ¦‚è¦ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

- éå…¬é–‹ã®Workerã§ã™ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ã§ãã¾ã›ã‚“ã€‚
- GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹ã¨ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å«ã‚€JSONã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚
  - `timestamp`: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ãŸæ™‚åˆ»
  - `random`: ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ä¾‹**

```json
{
  "timestamp": 1689031924677,
  "random": 4032682106
}
```

#### `wrangler.toml`

```toml
name = "apple"
usage_model = "bundled"
main = "src/worker.ts"
compatibility_date = "2023-06-28"
workers_dev = false
```

#### `src/worker.ts`

```ts
export default {
	async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
		const values = new Uint32Array(1);

		crypto.getRandomValues(values);

		return Response.json({
			timestamp: new Date().getTime(),
			random: values[0],
		});
	},
};
```

### ãƒãƒŠãƒŠWorkerã®æ¦‚è¦

ãƒãƒŠãƒŠWorkerã®æ¦‚è¦ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

- éå…¬é–‹ã®Workerã§ã™ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ã§ãã¾ã›ã‚“ã€‚
- ç‹¬è‡ªã®HTTPãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦`Happy-Message`ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚
- POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿å—ã‘ä»˜ã‘ã¾ã™ã€‚POSTã§ãªã‘ã‚Œã°400 Bad requestã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã™ã€‚
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯JSONã§ã™ã€‚ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨ã—ã¦`happiness`ã‚’å«ã¿ã¾ã™ã€‚
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦JSONã‚’è¿”ã—ã¾ã™ã€‚
  - `Happy-Message`ãƒ˜ãƒƒãƒ€ãƒ¼ã§æŒ‡å®šã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã—ã¾ã™ã€‚
  - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯`happiness`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§æŒ‡å®šã•ã‚ŒãŸå›æ•°ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¾‹**

```text
Happy-Message: "I'm happy!"

{
  happiness: 3
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ä¾‹**

```json
{
  "message": "I'm happy! I'm happy! I'm happy!"
}
```

#### `wrangler.toml`

```toml
name = "banana"
usage_model = "bundled"
main = "src/worker.ts"
compatibility_date = "2023-06-28"
workers_dev = false
```

#### `src/worker.ts`

```ts
interface BananaRequest {
	happiness: number;
}

export default {
	async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
		if (request.method !== 'POST') {
			return new Response('Oops!', { status: 400 });
		}

		const body: BananaBody = await request.json();
		const happiness = body.happiness > 0 && body.happiness < 10 ? body.happiness : 1;
		const message = request.headers.get('Happy-Message') + ' ';

		return Response.json({
			message: message.repeat(happiness).trim(),
		});
	},
};
```

### ã•ãã‚‰ã‚“ã¼Workerã®æ¦‚è¦

ã•ãã‚‰ã‚“ã¼Workerã®æ¦‚è¦ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹ã•ã‚Œã¾ã™ã€‚
- ã‚Šã‚“ã”Workerã¨ãƒãƒŠãƒŠWorkerã«HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã®è©³ç´°ã«ã¤ã„ã¦ã¯æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª¬æ˜ã—ã¾ã™ã€‚

#### `wrangler.toml`

```toml
name = "cherry"
usage_model = "bundled"
main = "src/worker.ts"
compatibility_date = "2023-06-28"

services = [
  { binding = "Worker1", service = "apple" },
  { binding = "Worker2", service = "banana" }
]
```

#### `src/worker.ts`

```ts
export interface Env {
	Worker1: Fetcher;
	Worker2: Fetcher;
}

interface Worker1Response {
	timestamp: number;
	random: number;
}

interface Worker2Response {
	message: string;
}

export default {
	async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
		const response1 = await env.Worker1.fetch(request.clone());
		const response2 = await env.Worker1.fetch(request.clone());
		const response3 = await env.Worker2.fetch(request.url, {
			cf: request.cf,
			method: 'POST',
			headers: new Headers({
				...request.headers,
				'Content-Type': 'application/json',
				'Happy-Message': "I'm happy!",
			}),
			body: JSON.stringify({
				happiness: 3,
			}),
		});

		const body1: ResponseBody = await response1.json();
		const body2: ResponseBody = await response2.json();
		const body3: ResponseBody = await response3.json();

		return Response.json({
			worker1: {
				first: { ...body1 },
				second: { ...body2 },
			},
			worker2: {
				...body3,
			},
		});
	},
};
```

#### ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ä¾‹

```json
{
  "worker1": {
    "first": {
      "timestamp": 1689031924677,
      "random": 4032682106
    },
    "second": {
      "timestamp": 1689031924677,
      "random": 2321664665
    }
  },
  "worker2": {
    "message": "I'm happy! I'm happy! I'm happy!"
  }
}
```

## ã‚³ãƒ¼ãƒ‰ã®è§£èª¬

## å®Ÿè£…ã®æ³¨æ„ç‚¹

## å‚è€ƒè³‡æ–™
