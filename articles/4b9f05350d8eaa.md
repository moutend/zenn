---
title: "入門 Cloudflare Realtime -- WebRTC を利用したビデオ通話アプリの作り方"
emoji: "💬"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Cloudflare, WebRTC, JavaScript]
published: false
---
## はじめに

本記事ではブラウザで動作するビデオ通話アプリの実装方法を解説します。実装にあたってはSDKやフレームワークを利用せず、素のJavaScriptで実装します。  
対象読者はWebRTCに触れた経験のない方です。必要な知識を都度説明するため、記事の冒頭から順を追って読み進めることをお勧めします。  
本記事で実装するビデオ通話アプリはSFUとしてCloudflare Realtimeを利用します。「SFUって何だ？」と思われた方、後ほど解説しますのでご安心ください。  

### 費用について

費用は発生しません。後ほど詳しく説明しますが、本記事で利用するCloudflare Realtimeには毎月1,000 GBの無料データ転送量が含まれます。個人でビデオ通話アプリの動作確認をする程度であれば、この無料枠で十分に足ります。  

### 動作確認後のアプリ削除について

本記事で実装するビデオ通話アプリはあくまでサンプルです。ユーザー認証機能がありません。デプロイされたURLを知っている人であれば誰でも利用できます。  
また、今回の実装は動作の仕組みが理解できることを優先するため、Cloudflare Realtimeシークレットをクライアント側のJavaScriptに埋め込みます。本来、シークレットが漏洩するような方法で実装を行ってはいけません。  
従って、動作確認が終わった後にアプリを削除せず放置していると、意図せず利用されて課金される恐れがあります。手順については削除方法の章で説明しますので、指示に従ってください。  

## Cloudflare Realtimeとは

Cloudflare Realtimeはビデオ通話などのリアルタイム通信機能を実現するサービスです。以前はCloudflare Callsとよばれていましたが、2025年4月に正式リリースされると同時にサービス名が変更されました。

**リリースブログ**

- [（原文）Make your apps truly interactive with Cloudflare Realtime and RealtimeKit - The Cloudflare Blog](https://blog.cloudflare.com/introducing-cloudflare-realtime-and-realtimekit/)
- [（翻訳）Cloudflare RealtimeとRealtimeKitでアプリを本当の意味でインタラクティブに - The Cloudflare Blog](https://www.google.com/search?client=safari&rls=en&q=cloudflare+realtime+release&ie=UTF-8&oe=UTF-8)。

リリースブログで言及されているRealtimeKit SDKについては本記事を投稿した時点で非公開ベータ版です。一般には提供されていません。また、本記事ではRealtimeKit SDKについての解説は行いません。

### Cloudflare RealtimeはTURNとSFUを提供するフルマネージドサービスである

「Cloudflare Realtimeはリアルタイム通信機能を実現するサービスである」そのように説明されても抽象的すぎます。具体的には、何を提供するのでしょうか。  
それでは具体的に説明しましょう。Cloudflare RealtimeはフルマネージドなTURNサーバーとSFUサーバーを提供します。今度は具体的すぎたでしょうか。  
Cloudflare Realtimeが提供するサービスの利用方法を理解するにはWebRTCの知識が必要になります。まずはWebRTCの概要を把握しましょう。  

## WebRTC とは

WebRTC（Web RealTime Communication）は双方向のリアルタイム通信を実現するために策定されたAPIやプロトコルの集合です。技術仕様はRFCとして公開されています。  
ほとんどのブラウザに標準機能として搭載されているため、拡張機能やプラグインを追加することなく利用できるのがWebRTCの特徴です。また、Webとは名乗っていますが、その利用はブラウザだけに制限されません。プロトコルに従えばWebブラウザとモバイルアプリの間で通信する、といったことが可能です。  
WebRTCの技術仕様は多岐に渡り、仕様を網羅的に理解するのは困難です。[^1]本記事ではCloudflare Realtimeを利用するために必要となる知識に絞ってWebRTCの基礎を説明します。  

[^1]: WebRTCについての素晴らしい解説記事を見つけた、と思ったら途中で力尽きていました。WebRTC完全理解への道は険しいようです。 https://zenn.dev/yuki_uchida/books/c0946d19352af5/viewer/0e7daa

### WebRTCはP2Pのプロトコルである

WebRTCはサーバーを経由せず通信するプロトコルです。通信に参加する者をピアとよび、ピア同士で直接通信する方式をP2P（peer-to-peer）とよびます。  
ただし、全くサーバーを利用しないわけではありません。以降で補足します。  

### STUNとは

私たちが普段利用するデバイスは直接インターネットに接続しているわけではありません。多くの場合、通信経路の途中でNAT（Network Address Translator）を経由します。NATはインターネットとローカルなネットワークの中間に配置され、それぞれのネットワークに割り振られたアドレスを相互に変換します。
例えば、iPhoneの設定アプリを開いて設定→WiFi→詳細情報→IPv4アドレスを確認してみてください。おそらく、`192.168.xxx.xxx`というアドレスが割り振られているはずです。このアドレスはローカルなネットワークに割り振られたアドレスです。  
P2Pで通信を行うにはインターネット側に割り振られたアドレスを知る必要があります。そこで登場するのがSTUN（Session Traversal Utilities for NAT）サーバーです。STUNサーバーに問い合わせることで、インターネット側に割り振られたアドレスを知ることができます。  
Cloudflare Realtimeを構成する要素にはSTUNサーバーが含まれています。STUNサーバーはCloudflareが管理しているため、我々が管理する手間なく利用できます。  

:::details 5 tuplesとは

### 5 tuplesとは

WebRTCに限った話題ではありませんが、P2P通信の文脈では5 tuples（ファイブ・タプル）とよばれる項目があります。以下5つの要素で構成されます。  

- 送信元のIPアドレス
- 送信元のポート番号
- 送信先のIPアドレス
- 送信先のポート番号
- トランスポートプロトコル（UDPなど）

少なくとも、これら5つの情報が揃わなければP2Pで通信できません。WebRTCの文脈で5 tuplesについて言及している場合、上記の項目について言及しているのだと読み替えてください。  

:::

### TURNとは

### SFUとは

1. Aliceか利用可能な音声・映像コーデックをBobに伝える。
2. Bobが利用可能な音声・映像コーデックをAliceに伝える。
3. AliceとBobお互いが利用可能な最大公約数の音声・映像コーデックを使って通信を開始する。
## 参考文献

1. [Introduction to the Real-time Transport Protocol (RTP) - Web APIs - MDN](https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Intro_to_RTP)
