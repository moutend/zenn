---
title: "macOSのSafariで任意のWeb APIに接続できない状況を擬似的に再現する"
emoji: "🐡"
type: "tech"
topics: [macOS Safari]
published: false
---
# はじめに

記事の投稿にあたり、以下の環境で動作検証を行いました。

- macOS Monterey 12.6.3
- Safari 16.3

# 要件

以下のWebサイトがあると仮定します。

- 普段は`https://example.com/api/v2/`（プライマリAPI）を呼び出している。
- システム障害など何らかの理由でプライマリAPIに接続できない場合は`https://api.example.net/v1/`（セカンダリAPI）を呼び出す。
- プライマリAPIとセカンダリAPIどちらも接続できない場合は障害告知のtwitterフィードを表示する。

以下の要件を満たす方法を考えます。

- APIに接続できない状況を再現したい。
  - あくまでWebサイトの表示が切り替わるかを確認したいだけ。ただしデプロイされているJavaScriptやCSSに手を加えてはならない。
  - 500 Internal Server Errorを返したりコネクションのタイムアウトを再現したりといったレスポンスの細かな制御は不要。JavaScriptの`fetch()`や`xhr()`が失敗する状況を再現できればよい。
  - `https://example.com/api/*`のように接続できない範囲をワイルドカードで指定したい。
- 2つの状況を再現したい。
  1. プライマリAPIのみ接続できない
  2. プライマリAPIとセカンダリAPIどちらも接続できない

# 実現方法

Safariの標準機能でURLにもとづいたアクセス制限ができればよいのですが、そのような機能は見つかりませんでした。ということでSafari Web Extensionを作ります。

Safari Web Extensionといっても大袈裟なものではなく、この後に示すのは10行にも満たないコードです。複雑なことは一歳しませんので安心してください。

後ほど余談として今回の要件を実現するのに検討した方法を紹介します。

# （余談）検討した方法

## ペアレンタルコントロール

## SafariのLocal Overrides

## WiFiルーターのアクセス制限機能

# 参考資料

1. [Blocking content with your Safari web extension | Apple Developer Documentation](https://developer.apple.com/documentation/safariservices/safari_web_extensions/blocking_content_with_your_safari_web_extension)
2. [chrome.declarativeNetRequest - Chrome Developers](https://developer.chrome.com/docs/extensions/reference/declarativeNetRequest/#type-RuleCondition)
3. [](https://github.com/requestly/modify-headers-manifest-v3)
