---
title: "ï¼ˆå®Ÿè·µCloudflare Workersï¼‰MailChannels APIã‚’åˆ©ç”¨ã—ã¦Workerã‹ã‚‰ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹"
emoji: "ğŸ’¬"
type: "tech"
topics: [Cloudflare, "Cloudflare Workers", MailChannels, ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³, ãƒ¡ãƒ¼ãƒ«]
published: false
---
## ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã§ã¯Cloudflare Workersã‹ã‚‰ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡ã«ã¯MailChannels APIã‚’åˆ©ç”¨ã—ã¾ã™ã€‚è‡ªå‰ã®ãƒ¡ãƒ¼ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚’ç”¨æ„ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ç”¨é€”ã¨ã—ã¦ã¯æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

- å•ã„åˆã›ãƒ•ã‚©ãƒ¼ãƒ ã®å—ã‘ä»˜ã‘ãƒ¡ãƒ¼ãƒ« ... ï¼ˆä¾‹ï¼‰ã€ŒãŠå•ã„åˆã›ã‚’å—ã‘ä»˜ã‘ã—ã¾ã—ãŸã€‚æ‹…å½“è€…ã‹ã‚‰ã®å›ç­”ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚ã€
- ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã—ãŸéš›ã®ä»®ç™»éŒ²ãƒ¡ãƒ¼ãƒ« ... ï¼ˆä¾‹ï¼‰ã€Œç™»éŒ²ã¯ã¾ã å®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç™»éŒ²ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚ã€
- ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ãƒ¡ãƒ¼ãƒ« ... ï¼ˆä¾‹ï¼‰ã€Œæ™®æ®µã¨ç•°ãªã‚‹ç«¯æœ«ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã•ã‚Œã¾ã—ãŸã€‚å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ãŠå•ã„åˆã›ãã ã•ã„ã€‚ã€

ãªãŠã€Cloudflare Workersã«ã¯ãƒ¡ãƒ¼ãƒ«ã®å—ä¿¡ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«èµ·å‹•ã™ã‚‹Email WorkersãŒã‚ã‚Šã¾ã™ã€‚ã“ã®è¨˜äº‹ã§æ‰±ã†ã®ã¯ã‚ãã¾ã§ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡é£²ã¿ã§ã™ã€‚é€ä¿¡ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã«è¿”ä¿¡ã™ã‚‹ã¨ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰è‡ªå‹•å¿œç­”ã™ã‚‹ã€ã¨ã„ã£ãŸã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªä»•çµ„ã¿ã®å®Ÿè£…ã«ã¤ã„ã¦ã¯èª¬æ˜ã—ã¾ã›ã‚“ã€‚

## å®Ÿè¡Œç’°å¢ƒ

è¨˜äº‹ã®æŠ•ç¨¿ã«ã‚ãŸã‚Šã€ä»¥ä¸‹ã®ç’°å¢ƒã«ã¦å‹•ä½œç¢ºèªã‚’è¡Œã„ã¾ã—ãŸã€‚

- wranglerã‚³ãƒãƒ³ãƒ‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v3.2.0
- wrangler.tomlãƒ•ã‚¡ã‚¤ãƒ«ã®`compatibility_date`: 2023-07-10

## ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã¤ã„ã¦ã®å‰æ

Cloudflare Workersã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹å ´åˆã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯Cloudflareã§å–å¾—ã—ãŸã‚‚ã®ã«é™ã‚Šã¾ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æ–°è¦è³¼å…¥ã¾ãŸã¯ç§»ç®¡ã™ã‚‹æ‰‹é †ã«ã¤ã„ã¦ã¯èª¬æ˜ã—ã¾ã›ã‚“ã€‚ã¨ã„ã£ã¦ã‚‚ã€ä½œæ¥­ã¯ç°¡å˜ã§ã™ã®ã§æ¬¡ã®è¨˜äº‹ã‚’å‚è€ƒã«é€²ã‚ã¦ã¿ã¦ãã ã•ã„ã€‚

- ï¼ˆå‚è€ƒï¼‰[Cloudflare Registrar ã§ãƒ‰ãƒ¡ã‚¤ãƒ³å–å¾—ã™ã‚‹ - Qiita](https://qiita.com/khayama/items/fdda7884033b519aa1fe)

ã¨ã“ã‚ã§ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã®è¨˜äº‹ã®ä¸­ã«ã¯ã€Cloudflareã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ç§»ç®¡ã®ã¿å¯¾å¿œã—ã¦ã„ã‚‹ã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚ãã®ã‚ˆã†ãªè¨˜äº‹ã¯èª¤ã‚Šã§ã™ã€‚

è¨˜äº‹ã‚’åŸ·ç­†ã—ã¦ã„ã‚‹2023å¹´7æœˆç¾åœ¨ã€Cloudflareã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æ–°è¦è³¼å…¥ã§ãã¾ã™ã€‚å®‰å£²ã‚Šã—ã¦ã„ã‚‹æ¥­è€…ã¨æ¯”è¼ƒã™ã‚‹ã¨å‰²é«˜ã«æ„Ÿã˜ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€å¦¥å½“ãªä¾¡æ ¼ã§è²©å£²ã•ã‚Œã¦ã„ã¾ã™ã€‚

ä½™è«‡ã«ãªã‚Šã¾ã™ãŒã€TLDã®ä¸­ã«ã¯å•ç­”ç„¡ç”¨ã§è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«åˆ¤å®šã•ã‚Œã‚‹ã‚‚ã®ãŒã‚ã‚‹ãã†ã§ã™ã€‚ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„ãƒˆãƒ©ãƒ–ãƒ«ã‚’é¿ã‘ã‚‹ãŸã‚ã«ã€`.comã‚„`.net`ãªã©ã®ç„¡é›£ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã®å–å¾—ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

## ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¨é©åˆ‡ãªDNSè¨­å®š

Cloudflareå…¬å¼ãƒ–ãƒ­ã‚°ã«ã¯MailChannels APIã‚’åˆ©ç”¨ã™ã‚Œã°æ‰‹è»½ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒã§ãã‚‹ã¨æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚ãŸã ã—ã€æœ€ã‚‚é‡è¦ãªé …ç›®ãŒçœç•¥ã•ã‚Œã¦ã„ã¾ã™ã€‚DNSã®è¨­å®šã§ã™ã€‚

- ï¼ˆå‚è€ƒï¼‰[Send email using Workers with MailChannels - The Cloudflare Blog](https://blog.cloudflare.com/sending-email-from-workers-with-mailchannels/)

è¨˜äº‹ãŒé•·ããªã‚‹ã®ã‚’é¿ã‘ã‚‹ãŸã‚èª¬æ˜ã‚’çœç•¥ã—ãŸã‚‚ã®ã¨æ€ã‚ã‚Œã¾ã™ã€‚ã—ã‹ã—ã€ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é‹ç”¨ã™ã‚‹ã®ã§ã‚ã‚Œã°é©åˆ‡ãªDNSã®è¨­å®šã¯å¿…é ˆã§ã™ã€‚

DNSã®è¨­å®šã‚’çœç•¥ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ä¸éƒ½åˆãŒç”Ÿã˜ã¾ã™ã€‚

1. è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ã¨ã—ã¦åˆ¤å®šã•ã‚Œã‚‹æã‚ŒãŒã‚ã‚‹ã€‚
2. ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„æã‚ŒãŒã‚ã‚‹ã€‚
3. ç¬¬ä¸‰è€…ã®ãªã‚Šã™ã¾ã—ãƒ¡ãƒ¼ãƒ«ã‚’æ’é™¤ã§ããªã„ã€‚

ãã“ã§ã€æœ€åˆã«MailChannels APIã‚’åˆ©ç”¨ã—ãŸãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®å®Ÿè£…ä¾‹ã‚’ç¤ºã—ã€ãã®å¾Œã«DNSã®è¨­å®šã«ã¤ã„ã¦è©³ã—ãèª¬æ˜ã—ã¾ã™ã€‚

## å®Ÿè£…ä¾‹

ä»¥ä¸‹ã¯MailChannels APIã‚’åˆ©ç”¨ã—ãŸãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®å®Ÿè£…ä¾‹ã§ã™ã€‚ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ã—ã¦`example.com`ã‚’å–å¾—ã—ãŸæƒ³å®šã§å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ã“ã®å¾Œã€DNSã®è¨­å®šã«ã¤ã„ã¦èª¬æ˜ã™ã‚‹éƒ½åˆä¸Šã€TypeScriptã§å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

ãªãŠã€ä»¥ä¸‹ã®å®Ÿè£…ã¯HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®èªè¨¼ã‚’ä¸€æ­³ã—ã¦ã„ã¾ã›ã‚“ã—ã€GETãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚‚å¿œç­”ã™ã‚‹å½¢ã«ãªã£ã¦ã„ã¾ã™ã€‚é‹ç”¨ã™ã‚‹éš›ã¯Service bindingsã‚’åˆ©ç”¨ã—ã¦ã€ä»–ã®Workerã‹ã‚‰å‘¼ã³å‡ºã™ãªã©åˆ¶é™ã‚’ã‹ã‘ã¦ãã ã•ã„ã€‚

**wrangler.toml**

```toml
name = "sendmail"
main = "src/worker.ts"
compatibility_date = "2023-07-10"
```

**src/worker.ts**

```ts
export interface Env {
	DKIMPrivateKey: string;
}

interface EmailAddress {
	email: string;
	name?: string;
}

interface Personalization {
	to: [EmailAddress, ...EmailAddress[]];
	from?: EmailAddress;
	dkim_domain?: string;
	dkim_private_key?: string;
	dkim_selector?: string;
	reply_to?: EmailAddress;
	cc?: EmailAddress[];
	bcc?: EmailAddress[];
	subject?: string;
	headers?: Record<string, string>;
}

interface ContentItem {
	type: string;
	value: string;
}

interface MailSendBody {
	personalizations: [Personalization, ...Personalization[]];
	from: EmailAddress;
	reply_to?: EmailAddress;
	subject: string;
	content: [ContentItem, ...ContentItem[]];
	headers?: Record<string, string>;
}

export default {
	async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
		const toEmailAddress: EmailAddress = {
			email: 'é€ä¿¡å…ˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
			name: 'é€ä¿¡å…ˆã®åå‰ï¼ˆçœç•¥å¯ï¼‰',
		};
		const fromEmailAddress: EmailAddress = {
			email: 'é€ä¿¡å…ƒã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä¾‹ï¼šno-reply@example.comï¼‰',
			name: 'é€ä¿¡å…ƒã®åå‰ï¼ˆçœç•¥å¯ï¼‰',
		};
		const personalization: Personalization = {
			to: [toEmailAddress],
			from: fromEmailAddress,
			dkim_domain: 'example.com',
			dkim_selector: 'mailchannels',
			dkim_private_key: env.DKIMPrivateKey,
		};
		const now = new Date().getTime();
		const content: ContentItem = {
			type: 'text/plain',
			value: 'ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡',
		};
		const payload = {
			personalizations: [personalization],
			from: fromEmailAddress,
			subject: 'ãƒ¡ãƒ¼ãƒ«ã®ä»¶å',
			content: [content],
		};
		const response = await fetch('https://api.mailchannels.net/tx/v1/send', {
			method: 'POST',
			headers: {
				'content-type': 'application/json',
			},
			body: JSON.stringify(payload),
		});

		if (response.status === 202) {
			return Response.json({
				success: true,
			});
		}
		try {
			const { errors } = await response.clone().json();

			return Response.json({
				success: false,
				errors,
			});
		} catch {
			return Response.json({
				success: false,
				errors: [response.statusText],
			});
		}
	},
};
```

## DNSã®è¨­å®š

### ï¼ˆæ‰‹é †0ï¼‰ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®é–‹ãæ–¹

1. Cloudflareã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹ãã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä¸­ã®Manage Domainsã‚’é¸ã³ã¾ã™ã€‚
2. å–å¾—æ¸ˆã¿ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚å¯¾è±¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¦‹ã¤ã‘ãŸã‚‰Manageã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚ã“ã“ã§ã¯ä»®ã«`example.com`ã‚’é¸ã‚“ã ã‚‚ã®ã¨ã—ã¾ã™ã€‚
3. `example.com`ã®è©³ç´°ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä¸­ã®Configurationã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
4. DNSSECã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚
5. Update DNS configurationã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

### ï¼ˆæ‰‹é †1ï¼‰Domain Lockdownâ„¢ãƒ¬ã‚³ãƒ¼ãƒ‰ã®è¿½åŠ 

### ï¼ˆæ‰‹é †2ï¼‰SPFãƒ¬ã‚³ãƒ¼ãƒ‰ã®è¿½åŠ 

### ï¼ˆæ‰‹é †3ï¼‰DKIMãƒ¬ã‚³ãƒ¼ãƒ‰ã®è¿½åŠ 

### ï¼ˆæ‰‹é †4ï¼‰DMARCãƒ¬ã‚³ãƒ¼ãƒ‰ã®è¿½åŠ 
Required steps to complete zone set-up

2. ã€Œset up restrictive SPF, DKIM, and DMARC recordsã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚
3. Email Record Creatorç”»é¢ã«é·ç§»ã—ã¾ã™ã€‚

## è©¦é‹è»¢

## åˆ¶é™

### ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã§ããªã„

1. ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡å…ƒã¨ã—ã¦`no-reply@contact.example.com`ã®ã‚ˆã†ãªã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯æŒ‡å®šã§ãã¾ã›ã‚“ã€‚

## å‚è€ƒè³‡æ–™

1. [Send email using Workers with MailChannels - The Cloudflare Blog](https://blog.cloudflare.com/sending-email-from-workers-with-mailchannels/)
2. [Tackling Email Spoofing and Phishing - The Cloudflare Blog](https://blog.cloudflare.com/tackling-email-spoofing/)
3. [What is a DNS DKIM record? - Cloudflare](https://www.cloudflare.com/learning/dns/dns-records/dns-dkim-record/)
4. [MailChannels Pages Plugin - Cloudflare Pages docs](https://developers.cloudflare.com/pages/platform/functions/plugins/mailchannels/)
5. [Sending Email from Cloudflare Workers using MailChannels Send API - MailChannels Help Center](https://support.mailchannels.com/hc/en-us/articles/4565898358413-Sending-Email-from-Cloudflare-Workers-using-MailChannels-Send-API)
6. [Secure your domain name against spoofing with Domain Lockdownâ„¢ - MailChannels Help Center](https://support.mailchannels.com/hc/en-us/articles/16918954360845-Secure-your-domain-name-against-spoofing-with-Domain-Lockdown-)
7. [Set up SPF Records - MailChannels Help Center](https://support.mailchannels.com/hc/en-us/articles/200262610-Set-up-SPF-Records)
8. [å®Ÿè·µDNS - DNSSECæ™‚ä»£ã®DNSã®è¨­å®šã¨é‹ç”¨ - é”äººå‡ºç‰ˆä¼š](https://tatsu-zine.com/books/dns)
