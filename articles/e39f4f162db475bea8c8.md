---
title: "[Swift] vDSPã‚’åˆ©ç”¨ã—ã¦é«˜é€Ÿãƒ•ãƒ¼ãƒªã‚¨å¤‰æ›ã™ã‚‹"
emoji: "ðŸ˜º"
type: "tech"
topics: [Swift iOS DSP]
published: false
---
## vDSPã¨ã¯

æ•°å€¤è¨ˆç®—ã‚„ãƒ‡ã‚¸ã‚¿ãƒ«ä¿¡å·å‡¦ç†ã‚’é«˜é€Ÿã«è¡Œã†ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒ[vDSP](https://developer.apple.com/documentation/accelerate/vdsp)ã§ã™ã€‚Xcodeã«æœ€åˆã‹ã‚‰å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€è¿½åŠ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ã•ã¦ã€vDSPã«ã¯1æ¬¡å…ƒã®é«˜é€Ÿãƒ•ãƒ¼ãƒªã‚¨å¤‰æ›ã‚’è¡Œã†`vDSP.FFT`ãŒã‚ã‚Šã¾ã™ã€‚iOS 14ã‹ã‚‰åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

## vDSPã‚’åˆ©ç”¨ã—ãŸé«˜é€Ÿãƒ•ãƒ¼ãƒªã‚¨å¤‰æ›

ä¾‹ã¨ã—ã¦ã€è¤‡ç´ æ•°ã®å®Ÿéƒ¨ã®ã¿ãŒè¨˜éŒ²ã•ã‚ŒãŸFloatã®é…åˆ—ã‚’å—ã‘å–ã‚Šã€çµæžœã‚’è¤‡ç´ æ•°ã¨ã—ã¦è¿”ã™å‡¦ç†ã‚’ç¤ºã—ã¾ã™ã€‚éŸ³å£°ä¿¡å·ãªã©ã®è§£æžã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

ãªãŠã€Swiftã¯è¤‡ç´ æ•°åž‹ãŒæä¾›ã•ã‚Œã¦ã„ãªã„ãŸã‚ç‹¬è‡ªã«Complex64ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚é–¢æ•°ã®æˆ»ã‚Šå€¤ã¨ã—ã¦å®Ÿéƒ¨ã®é…åˆ—ã¨è™šéƒ¨ã®é…åˆ—ã‚’è¿”ã—ã¦ã‚‚è‰¯ã„ã®ã§ã™ãŒã€å¾Œã§vDSPã‚’ä½¿ã‚ãªã„å ´åˆã¨ã®æ¯”è¼ƒã‚’ã™ã‚‹ãŸã‚ã€ã“ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

```swift
import Accelerate

struct Complex64 {
    var real: Float
    var imag: Float

    init(_ r: Float, _ i: Float) {
        self.real = r
        self.imag = i
    }
}

func FFT(signal: [Float]) -> [Complex64] {
    let log2n = vDSP_Length(log2(Float(signal.count)) + 1)
    let fft = vDSP.FFT(log2n: log2n, radix: .radix2, ofType: DSPSplitComplex.self)!

    var inputReal = [Float](signal)
    var inputImag = [Float](repeating: 0.0, count: signal.count)
    var outputReal = [Float](repeating: 0.0, count: signal.count)
    var outputImag = [Float](repeating: 0.0, count: signal.count)

    inputReal.withUnsafeMutableBufferPointer { inputRealPtr in
        inputImag.withUnsafeMutableBufferPointer { inputImagPtr in
            outputReal.withUnsafeMutableBufferPointer { outputRealPtr in
                outputImag.withUnsafeMutableBufferPointer { outputImagPtr in
                    let input = DSPSplitComplex(realp: inputRealPtr.baseAddress!, imagp: inputImagPtr.baseAddress!)
                    var output = DSPSplitComplex(realp: outputRealPtr.baseAddress!, imagp: outputImagPtr.baseAddress!)

                    fft.forward(input: input, output: &output)
                }
            }
        }
    }

    var spectrum = [Complex64](repeating: Complex64(0.0, 0.0), count: signal.count)

    for i in 0 ..< signal.count {
        spectrum[i].real = outputReal[i]
        spectrum[i].imag = outputImag[i]
    }

    return spectrum
}
```

## ä½Žé€Ÿãªé«˜é€Ÿãƒ•ãƒ¼ãƒªã‚¨å¤‰æ›

vDSPãŒã©ã‚Œã»ã©é«˜é€Ÿãªã®ã‹ç¢ºã‹ã‚ã‚‹ãŸã‚ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä¸€åˆ‡ä½¿ã‚ãšã«é«˜é€Ÿãƒ•ãƒ¼ãƒªã‚¨å¤‰æ›ã‚’å®Ÿè£…ã—ã¾ã™ã€‚å®Ÿè£…æ–¹æ³•ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚

- [é«˜é€Ÿãƒ•ãƒ¼ãƒªã‚¨å¤‰æ›(FFT)ã‚’ãŠã˜ã•ã‚“ã‚‚C++ã§ä½œã£ã¦ã¿ãŸã‚ˆ - nursã®æ—¥è¨˜](https://nurs.hatenablog.com/entry/20130617/1371483633)

```swift
import Foundation

struct Complex64 {
    var real: Float
    var imag: Float

    init(_ r: Float, _ i: Float) {
        self.real = r
        self.imag = i
    }
}

extension Complex64 {
    static func +(left: Complex64, right: Complex64) -> Complex64 {
        return Complex64(left.real + right.real, left.imag + right.imag)
    }
    static func +=(left: inout Complex64, right: Complex64) {
        left = left + right
    }
    static func -(left: Complex64, right: Complex64) -> Complex64 {
        return Complex64(left.real - right.real, left.imag - right.imag)
    }
    static func -=(left: inout Complex64, right: Complex64) {
        left = left - right
    }
    static func *(left: Complex64, right: Complex64) -> Complex64 {
        return Complex64(left.real * right.real - left.imag * right.imag, left.real * right.imag + left.imag * right.real)
    }
    static func *=(left: inout Complex64, right: Complex64) {
        left = left * right
    }
}

func getIndex(_ length: Int) -> [Int] {
    let pow = Int(log2(Float(length)))
    var index: [Int] = []

    index.append(0)
    index.append(1)

    for _ in 0 ..< (pow - 1) {
        let indexLength = index.count

        for j in 0 ..< index.count {
            index[j] *= 2
        }
        for j in 0 ..< indexLength {
            index.append(index[j])
        }
        for j in indexLength ..< index.count {
            index[j] += 1
        }
    }

    return index
}

func FFT(signal: [Float]) -> [Complex64] {
    let length = signal.count
    let index = getIndex(length)
    let pow = Int(log2(Float(length)))

    var output = [Complex64]()

    for i in 0 ..< length {
        output.append(Complex64(signal[index[i]], 0.0))
    }

    var po2 = 1

    for _ in 1 ... pow {
        po2 = po2 << 1

        let po2m = po2 >> 1
        let theta = 2.0 * Double.pi / Double(po2)
        let w = Complex64(Float(cos(theta)), -Float(sin(theta)))

        var ws = Complex64(1.0, 0.0)

        for k in 0 ..< po2m {
            for j in stride(from: 0, to: length, by: po2) {
                let wfb = ws * output[j+k+po2m]

                output[j+k+po2m] = output[j+k] - wfb
                output[j+k] += wfb
            }

            ws *= w
        }
    }

    return output
}
```

## å®Ÿè¡Œæ™‚é–“ã®æ¯”è¼ƒ

å¤§é›‘æŠŠã§ã¯ã‚ã‚Šã¾ã™ãŒã€32768ã‚µãƒ³ãƒ—ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ãƒ¼ãƒªã‚¨å¤‰æ›ã—ãŸå ´åˆã®å®Ÿè¡Œæ™‚é–“ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«è¨ˆæ¸¬ã—ã¾ã™ã€‚

```swift
let signal = [Float](repeating: 0.0, count: 32768)
let start = Date()
let _ = FFT(signal: signal)
let elapsed = Date().timeIntervalSince(start)

print(elapsed)
```

[è¨ˆæ¸¬ã«ä½¿ç”¨ã—ãŸSwiftã®ã‚³ãƒ¼ãƒ‰](https://gist.github.com/moutend/065ed56bd45086d7a0f5c94916d602db)ã¯gistã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

å®Ÿã¯`vDSP.FFT`ã¯macOSã«ã‚‚æä¾›ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å…¨ãåŒã˜ã‚³ãƒ¼ãƒ‰ãŒmacOSã¨iOSã©ã¡ã‚‰ã§ã‚‚å‹•ä½œã—ã¾ã™ã€‚å®Ÿæ©Ÿã®iOS 14ç«¯æœ«ã‚’æº–å‚™ã™ã‚‹ã®ãŒé¢å€’ã ã£ãŸã®ã§ã€ä»Šå›žã¯`swift`ã‚³ãƒžãƒ³ãƒ‰ã‚’ä½¿ã£ã¦è¨ˆæ¸¬ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

```console
$ swift --version
Apple Swift version 5.3.2 (swiftlang-1200.0.45 clang-1200.0.32.28)
Target: x86_64-apple-darwin19.6.0
```

ã¾ãšã¯è‡ªåŠ›ã§å®Ÿè£…ã—ãŸä½Žé€Ÿãªé«˜é€Ÿãƒ•ãƒ¼ãƒªã‚¨å¤‰æ›ã‹ã‚‰ã€‚

```console
$ swift slow_fft.swift
0.13674700260162354
```

æ¬¡ã¯vDSPã‚’åˆ©ç”¨ã—ãŸé«˜é€Ÿãƒ•ãƒ¼ãƒªã‚¨å¤‰æ›ã§ã™ã€‚

```console
$ swift vdsp_fft.swift
0.022410988807678223
```

ã™ã°ã‚‰ã—ã„ã€å®Ÿè¡Œæ™‚é–“ã¯137 msã‹ã‚‰22 msã«çŸ­ç¸®ã•ã‚Œã¾ã—ãŸï¼ç´„6å€ã®é«˜é€ŸåŒ–ã§ã™ï¼

- æ³¨1 ... å®Ÿè¡Œæ™‚é–“ã®è¨ˆæ¸¬ã¯ãã‚Œãžã‚Œ10å›žå®Ÿè¡Œã—ã¦ä¸­å¤®å€¤ã‚’é¸ã³ã¾ã—ãŸã€‚
- æ³¨2 ... è¨ˆæ¸¬çµæžœã¯MacBook Air 2020 Intel Core i5ãƒ¢ãƒ‡ãƒ«ã®ã‚‚ã®ã§ã™ã€‚

## ï¼ˆè£œè¶³ï¼‰vDSPã§ãƒ•ãƒ¼ãƒªã‚¨å¤‰æ›ã—ãŸå ´åˆã®ã‚¼ãƒ­åŸ‹ã‚ã«ã¤ã„ã¦

vDSPã§ãƒ•ãƒ¼ãƒªã‚¨å¤‰æ›ã—ãŸçµæžœã¯`å…¥åŠ›ä¿¡å·ã®é…åˆ—ã®é•·ã• / 2`ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚¼ãƒ­åŸ‹ã‚ã•ã‚Œã¦ã„ã¾ã™ã€‚

é…åˆ—ã®åŠåˆ†ã¯ã‚¨ã‚¤ãƒªã‚¢ã‚·ãƒ³ã‚°ã§æŠ˜ã‚Šè¿”ã•ã‚ŒãŸå€¤ã§ã™ã€‚é€šå¸¸ã¯ä½¿ã‚ã‚Œãªã„å€¤ã§ã™ã®ã§ã‚¼ãƒ­åŸ‹ã‚ã•ã‚Œã¦ã„ã¦ã‚‚å•é¡Œãªã„ã¯ãšã§ã™ãŒã€ãã®ç‚¹ã¯æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
