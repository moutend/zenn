---
title: "（実践Cloudflare Workers）MailChannels APIを利用してWorkerから独自ドメインのメールを送信する"
emoji: "💬"
type: "tech"
topics: [Cloudflare, "Cloudflare Workers", MailChannels, 独自ドメイン, メール]
published: false
---
## はじめに

この記事ではCloudflare Workersから独自ドメインのメールを送信する方法について説明します。メールの送信にはMailChannels APIを利用します。自前のメールサーバーを用意する必要はありません。

用途としては次のようなものを想定しています。

- 問い合せフォームの受け付けメール ... （例）「お問い合せを受け付けしました。担当者からの回答をお待ちください。」
- サインアップした際の仮登録メール ... （例）「登録はまだ完了していません。以下のリンクをクリックして登録を完了してください。」
- アラート通知メール ... （例）「普段と異なる端末からログインされました。心当たりがない場合はお問い合せください。」

なお、Cloudflare Workersにはメールの受信をトリガーに起動するEmail Workersがあります。この記事で扱うのはあくまでメールの送信飲みです。送信されたメールに返信するとシステムから自動応答する、といったインタラクティブな仕組みの実装については説明しません。

## 実行環境

記事の投稿にあたり、以下の環境にて動作確認を行いました。

- wranglerコマンドのバージョン: v3.2.0
- wrangler.tomlファイルの`compatibility_date`: 2023-07-10

## 独自ドメインについての前提

Cloudflare Workersからメールを送信する場合、ドメインはCloudflareで取得したものに限ります。この記事ではドメインを新規購入または移管する手順については説明しません。といっても、作業は簡単ですので次の記事を参考に進めてみてください。

- （参考）[Cloudflare Registrar でドメイン取得する - Qiita](https://qiita.com/khayama/items/fdda7884033b519aa1fe)

ところで、インターネット上の記事の中には、Cloudflareはドメイン移管のみ対応していると書かれているものがあります。そのような記事は誤りです。

記事を執筆している2023年7月現在、Cloudflareでドメインを新規購入できます。安売りしている業者と比較すると割高に感じるかもしれませんが、妥当な価格で販売されています。

余談になりますが、TLDの中には問答無用で迷惑メール判定されるものがあるそうです。メールが届かないトラブルを避けるために、`.comや`.net`などの無難なドメインの取得をお勧めします。

## メール送信と適切なDNS設定

Cloudflare公式ブログにはMailChannels APIを利用すれば手軽にメール送信ができると書かれています。ただし、最も重要な項目が省略されています。DNSの設定です。

- （参考）[Send email using Workers with MailChannels - The Cloudflare Blog](https://blog.cloudflare.com/sending-email-from-workers-with-mailchannels/)

記事が長くなるのを避けるため説明を省略したものと思われます。しかし、プロダクション環境でアプリケーションを運用するのであれば適切なDNSの設定は必須です。

DNSの設定を省略すると、以下の不都合が生じます。

1. 迷惑メールとして判定される恐れがある。
2. メールが届かない恐れがある。
3. 第三者のなりすましメールを排除できない。

そこで、最初にMailChannels APIを利用したメール送信の実装例を示し、その後にDNSの設定について詳しく説明します。

## 実装例

以下はMailChannels APIを利用したメール送信の実装例です。独自ドメインとして`example.com`を取得した想定で実装しています。この後、DNSの設定について説明する都合上、TypeScriptで実装しています。

なお、以下の実装はHTTPリクエストの認証を一歳していませんし、GETメソッドのリクエストにも応答する形になっています。運用する際はService bindingsを利用して、他のWorkerから呼び出すなど制限をかけてください。

**wrangler.toml**

```toml
name = "sendmail"
main = "src/worker.ts"
compatibility_date = "2023-07-10"
```

**src/worker.ts**

```ts
export interface Env {
	DKIMPrivateKey: string;
}

interface EmailAddress {
	email: string;
	name?: string;
}

interface Personalization {
	to: [EmailAddress, ...EmailAddress[]];
	from?: EmailAddress;
	dkim_domain?: string;
	dkim_private_key?: string;
	dkim_selector?: string;
	reply_to?: EmailAddress;
	cc?: EmailAddress[];
	bcc?: EmailAddress[];
	subject?: string;
	headers?: Record<string, string>;
}

interface ContentItem {
	type: string;
	value: string;
}

interface MailSendBody {
	personalizations: [Personalization, ...Personalization[]];
	from: EmailAddress;
	reply_to?: EmailAddress;
	subject: string;
	content: [ContentItem, ...ContentItem[]];
	headers?: Record<string, string>;
}

export default {
	async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
		const toEmailAddress: EmailAddress = {
			email: '送信先のメールアドレス',
			name: '送信先の名前（省略可）',
		};
		const fromEmailAddress: EmailAddress = {
			email: '送信元のメールアドレス（例：no-reply@example.com）',
			name: '送信元の名前（省略可）',
		};
		const personalization: Personalization = {
			to: [toEmailAddress],
			from: fromEmailAddress,
			dkim_domain: 'example.com',
			dkim_selector: 'mailchannels',
			dkim_private_key: env.DKIMPrivateKey,
		};
		const now = new Date().getTime();
		const content: ContentItem = {
			type: 'text/plain',
			value: 'メール本文',
		};
		const payload = {
			personalizations: [personalization],
			from: fromEmailAddress,
			subject: 'メールの件名',
			content: [content],
		};
		const response = await fetch('https://api.mailchannels.net/tx/v1/send', {
			method: 'POST',
			headers: {
				'content-type': 'application/json',
			},
			body: JSON.stringify(payload),
		});

		if (response.status === 202) {
			return Response.json({
				success: true,
			});
		}
		try {
			const { errors } = await response.clone().json();

			return Response.json({
				success: false,
				errors,
			});
		} catch {
			return Response.json({
				success: false,
				errors: [response.statusText],
			});
		}
	},
};
```

## DNSの設定

### （手順0）ダッシュボードの開き方

1. Cloudflareのダッシュボードを開き、メニューの中のManage Domainsを選びます。
2. 取得済みドメインの一覧が表示されるはずです。対象のドメインを見つけたらManageをクリックします。ここでは仮に`example.com`を選んだものとします。
3. `example.com`の詳細画面が表示されます。メニューの中のConfigurationをクリックします。
4. DNSSECを有効にします。
5. Update DNS configurationをクリックします。

### （手順1）Domain Lockdown™レコードの追加

### （手順2）SPFレコードの追加

### （手順3）DKIMレコードの追加

### （手順4）DMARCレコードの追加
Required steps to complete zone set-up

2. 「set up restrictive SPF, DKIM, and DMARC records」ボタンを押します。
3. Email Record Creator画面に遷移します。

## 試運転

## 制限

### サブドメインからメールを送信できない

1. メールの送信元として`no-reply@contact.example.com`のようなサブドメインは指定できません。

## 参考資料

1. [Send email using Workers with MailChannels - The Cloudflare Blog](https://blog.cloudflare.com/sending-email-from-workers-with-mailchannels/)
2. [Tackling Email Spoofing and Phishing - The Cloudflare Blog](https://blog.cloudflare.com/tackling-email-spoofing/)
3. [What is a DNS DKIM record? - Cloudflare](https://www.cloudflare.com/learning/dns/dns-records/dns-dkim-record/)
4. [MailChannels Pages Plugin - Cloudflare Pages docs](https://developers.cloudflare.com/pages/platform/functions/plugins/mailchannels/)
5. [Sending Email from Cloudflare Workers using MailChannels Send API - MailChannels Help Center](https://support.mailchannels.com/hc/en-us/articles/4565898358413-Sending-Email-from-Cloudflare-Workers-using-MailChannels-Send-API)
6. [Secure your domain name against spoofing with Domain Lockdown™ - MailChannels Help Center](https://support.mailchannels.com/hc/en-us/articles/16918954360845-Secure-your-domain-name-against-spoofing-with-Domain-Lockdown-)
7. [Set up SPF Records - MailChannels Help Center](https://support.mailchannels.com/hc/en-us/articles/200262610-Set-up-SPF-Records)
8. [実践DNS - DNSSEC時代のDNSの設定と運用 - 達人出版会](https://tatsu-zine.com/books/dns)
