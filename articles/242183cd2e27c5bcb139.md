---
title: "[macOS] AVAudioEngineã®éŸ³å£°å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹åˆ‡ã‚Šæ›¿ãˆã‚’æ¤œçŸ¥ã™ã‚‹"
emoji: "ğŸ˜Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [macOS AVFoundation AVAudioEngine AVAudioSession AVAudioEngineConfigurationChange]
published: true
---
# çµè«–

macOSã§AVAudioSessionã®routeChangeNotificationã¯ä½¿ãˆã¾ã›ã‚“ã€‚

```
error: 'AVAudioSession' is unavailable in macOS
```

ä»£ã‚ã‚Šã«AVAudioEngineConfigurationChangeã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚

# ã¯ã˜ã‚ã«

ä»¥ä¸‹ã®ç’°å¢ƒã§å‹•ä½œæ¤œè¨¼ã—ã¾ã—ãŸã€‚

- Xcode 12.5 (12E262)
- macOS Big Sur 11.5.2

# å®Ÿè£…ä¾‹

ä»¥ä¸‹ã¯440 Hzã®ã‚µã‚¤ãƒ³æ³¢ã‚’å†ç”Ÿã™ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚å†ç”Ÿä¸­ã«å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹ãŒåˆ‡ã‚Šæ›¿ã‚ã£ã¦ã‚‚é€”åˆ‡ã‚Œã‚‹ã“ã¨ãªãå†ç”ŸãŒç¶šãã¾ã™ã€‚

```swift
import AVFoundation

class Engine {
  var engine = AVAudioEngine()
  var index = 0

  init() {
  setup()

    NotificationCenter.default.addObserver(
      self, selector: #selector(onConfigurationChange), name: .AVAudioEngineConfigurationChange,
      object: nil)
  }
  @objc func onConfigurationChange(notification: Notification) {
    print("Responding AVAudioEngineConfigurationChange")
    setup()
  }
  func setup() {
    let engine = AVAudioEngine()
    let outputFormat = engine.outputNode.inputFormat(forBus: 0)
    let sourceNode = AVAudioSourceNode(format: outputFormat) {
      _, _, frameCount, audioBufferList -> OSStatus in
      let ablPointer = UnsafeMutableAudioBufferListPointer(audioBufferList)

      for i in 0..<Int(frameCount) {
        for buffer in ablPointer {
        let phase = Double(self.index % Int(outputFormat.sampleRate))
        let signal = sin(440.0 * phase / outputFormat.sampleRate * 2.0 * Double.pi)
          let frame: UnsafeMutableBufferPointer<Float> = UnsafeMutableBufferPointer(buffer)

          frame[i] = Float(signal)
          // frame[i] = Float.random(in: -1.0...1.0)
        }

        self.index += 1
      }

      return noErr
    }

    engine.attach(sourceNode)
    engine.connect(sourceNode, to: engine.mainMixerNode, format: outputFormat)
    engine.prepare()

    do {
      try engine.start()
    } catch {
      fatalError("Failed to start AVAudioEngine: \(error)")
    }

    self.engine = engine
    print("Running AVAudioEngine: \(outputFormat.sampleRate) Hz / \(outputFormat.channelCount) ch")
  }
}

let e = Engine()

// éŸ³å£°ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¯åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§è¡Œã‚ã‚Œã‚‹ãŸã‚ã€ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã¯å¾…æ©ŸçŠ¶æ…‹ã«ã™ã‚‹ã€‚
var wg = DispatchGroup()

print("Press Ctrl-C to quit ...")

wg.enter()
wg.wait()
```

# è©¦é‹è»¢

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’`main.swift`ã¨ã—ã¦ä¿å­˜ã—ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```console
$ swift main.swift
```

ä»¥ä¸‹ã¯MacBookã®ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼â†’USBã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹â†’MacBookã®ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã¨åˆ‡ã‚Šæ›¿ãˆãŸå ´åˆã®ä¾‹ã§ã™ã€‚

```console
Running AVAudioEngine: 96000.0 Hz / 2 ch
Press Ctrl-C to quit ...
Responding AVAudioEngineConfigurationChange
Running AVAudioEngine: 44100.0 Hz / 2 ch
Responding AVAudioEngineConfigurationChange
Running AVAudioEngine: 96000.0 Hz / 2 ch
```

# ä½™è«‡

NotificationCenterã®addObserverã‚’å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯ã„ã¤ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚AVAudioEngineã®startãŒå®Ÿè¡Œã•ã‚Œã‚‹å‰ã§ã‚‚å¾Œã§ã‚‚å‹•ä½œã—ã¾ã™ã€‚

ãŸã ã—ã€addObserverã®å®Ÿè¡Œå¾Œã«startã‚’å®Ÿè¡Œã™ã‚‹ã¨å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹åˆ‡ã‚Šæ›¿ãˆã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã°ã‚Œãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚é »åº¦ã¯10å›ã«1å›ã»ã©ã§ã™ã€‚

Apple Developerã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯addObserverã‚’ã„ã¤å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã‹è¨˜è¼‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚addObserverã®å®Ÿè¡Œå¾Œã«startã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯æƒ³å®šã—ã¦ã„ãªã„ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ç¢ºå®Ÿã«å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹åˆ‡ã‚Šæ›¿ãˆã®é€šçŸ¥ã‚’å—ã‘å–ã‚‹ã«ã¯startã®å®Ÿè¡Œå¾Œã«addObserverã‚’å®Ÿè¡Œã™ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚

ã•ã‚‰ã«ä½™è«‡ã«ãªã‚Šã¾ã™ãŒã€AVAudioSessionã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯Availabilityã¨ã—ã¦macOS 11.0+ã®è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ã€‚Mac Catalystã¯AVAudioSessionã«å¯¾å¿œã—ã¦ã„ã‚‹ãŸã‚ã€macOSã®è¨˜è¿°ã¨é–“é•ãˆãŸã‚‚ã®ã¨æ€ã‚ã‚Œã¾ã™ã€‚

# å‚è€ƒè³‡æ–™

- [AVAudioEngineConfigurationChange - Apple Developer](https://developer.apple.com/documentation/foundation/nsnotification/name/1389078-avaudioengineconfigurationchange)
- [routeChangeNotification - Apple Developer](https://developer.apple.com/documentation/avfaudio/avaudiosession/1616493-routechangenotification)
