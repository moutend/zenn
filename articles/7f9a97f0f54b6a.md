---
title: "ï¼ˆSwiftï¼‰DispatchSourceã‚’ä½¿ã£ã¦UNIXã‚·ã‚°ãƒŠãƒ«ã‚’å—ä¿¡ã™ã‚‹"
emoji: "ğŸ˜"
type: "tech"
topics: [Swift, ã‚·ã‚°ãƒŠãƒ«, SIGINT]
published: true
---
## ã¯ã˜ã‚ã«

ä»¥ä¸‹ã®ç’°å¢ƒã§å‹•ä½œç¢ºèªã—ã¾ã—ãŸã€‚

- macOS 12.1 Monterey
- Swift 5.5.1

## å®Ÿè£…ä¾‹

DispatchSourceã‚’ä½¿ã£ã¦UNIXã‚·ã‚°ãƒŠãƒ«ã‚’å—ä¿¡ã™ã‚‹å®Ÿè£…ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚ä»¥ä¸‹ã¯SIGINTã‚’å—ä¿¡ã—ã¦ã€ŒReceived SIGINTã€ã¨è¡¨ç¤ºã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã™ã€‚

ãªãŠã€ã“ã®è¨˜äº‹ã§ã¯sigactioné–¢æ•°ã¨signalé–¢æ•°ã‚’ä½¿ã†2ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ²è¼‰ã—ã¾ã™ã€‚ã©ã®ã‚ˆã†ãªé•ã„ãŒã‚ã‚Šã€ã©ã¡ã‚‰ã‚’ä½¿ã†ã¹ãã‹ã«ã¤ã„ã¦ã¯å„è‡ªã§èª¿ã¹ã¦ãã ã•ã„ã€‚

### sigactioné–¢æ•°ã‚’ä½¿ã†å®Ÿè£…ä¾‹

```swift
import Foundation

func run() {
  let dg = DispatchGroup()

  // sigactionæ§‹é€ ä½“ã¨sigactioné–¢æ•°ã®åå‰ã®è¡çªã‚’é˜²ããŸã‚å‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’å®šç¾©ã™ã‚‹
  typealias SignalAction = sigaction

  var ignoreAction = SignalAction(
    __sigaction_u: unsafeBitCast(SIG_IGN, to: __sigaction_u.self),
    sa_mask: 0,
    sa_flags: 0
  )

  _ = withUnsafePointer(to: &ignoreAction) { ignoreActionPtr in
    // SIGINTã‚’å—ä¿¡ã—ãŸã¨ãã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æŒ™å‹•ã‚’ç„¡åŠ¹ã«ã—ã¦ãŠã
    sigaction(SIGINT, ignoreActionPtr, nil)
  }

  // ã‚·ã‚°ãƒŠãƒ«å—ä¿¡ç”¨ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã™ã‚‹
  let queue = DispatchQueue.global(qos: .default)

  let src = DispatchSource.makeSignalSource(signal: SIGINT, queue: queue)

  src.setEventHandler {
    print("Received SIGINT")
    dg.leave()
  }

  // ã‚·ã‚°ãƒŠãƒ«ã®å—ä¿¡ã‚’é–‹å§‹ã™ã‚‹
  src.activate()

  // ã‚·ã‚°ãƒŠãƒ«ã‚’å—ä¿¡ã™ã‚‹ã¾ã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒçµ‚äº†ã—ãªã„ã‚ˆã†ã«å¾…æ©Ÿã™ã‚‹
  dg.enter()
  dg.wait()

  print("Done")
}

run()
```

### signalé–¢æ•°ã‚’ä½¿ã†å®Ÿè£…ä¾‹

```swift
import Foundation

func run() {
  let dg = DispatchGroup()

  // SIGINTã‚’å—ä¿¡ã—ãŸã¨ãã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æŒ™å‹•ã‚’ç„¡åŠ¹ã«ã—ã¦ãŠã
  signal(SIGINT, SIG_IGN)

  // ã‚·ã‚°ãƒŠãƒ«å—ä¿¡ç”¨ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã™ã‚‹
  let queue = DispatchQueue.global(qos: .default)

  let src = DispatchSource.makeSignalSource(signal: SIGINT, queue: queue)

  src.setEventHandler {
    print("Received SIGINT")
    dg.leave()
  }

  // ã‚·ã‚°ãƒŠãƒ«ã®å—ä¿¡ã‚’é–‹å§‹ã™ã‚‹
  src.activate()

  // ã‚·ã‚°ãƒŠãƒ«ã‚’å—ä¿¡ã™ã‚‹ã¾ã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒçµ‚äº†ã—ãªã„ã‚ˆã†ã«å¾…æ©Ÿã™ã‚‹
  dg.enter()
  dg.wait()

  print("Done")
}

run()
```

### è£œè¶³äº‹é …

`makeSignalSource`ã«ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆ`DispatchQueue.main`ï¼‰ã‚’æ¸¡ã™ã¨å‡¦ç†ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ãŸã‚ã‚·ã‚°ãƒŠãƒ«ãŒå—ä¿¡ã§ãã¾ã›ã‚“ã€‚ãã®ãŸã‚ä¸Šè¨˜ã®å®Ÿè£…ä¾‹ã§ã¯`DispatchQueue.global`ã§ã‚·ã‚°ãƒŠãƒ«å—ä¿¡ç”¨ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

### è©¦é‹è»¢

ä¸Šè¨˜ã®å®Ÿè£…ä¾‹ã‚’`main.swift`ã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§`Ctrl-C`ã‚’å…¥åŠ›ã™ã‚‹ã‹`kill`ã‚³ãƒãƒ³ãƒ‰ã§SIGINTã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚

```console
$ swift main.swift
Received SIGINT
Done
```

## å‚è€ƒè³‡æ–™

- [DispatchSource - Apple Developer](https://developer.apple.com/documentation/dispatch/dispatchsource)
- [DispatchSourceProtocol - Apple Developer](https://developer.apple.com/documentation/dispatch/dispatchsourceprotocol)
