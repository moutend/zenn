---
title: "ãã®ãƒ†ãƒ¼ãƒ–ãƒ«é§†å‹•ãƒ†ã‚¹ãƒˆã€ä¸¦åˆ—ã«å®Ÿè¡Œã§ãã¾ã™ã‹ï¼Ÿ"
emoji: "ğŸ·"
type: "tech"
topics: [Go testing ãƒ†ã‚¹ãƒˆ]
published: true
---
## ã¯ã˜ã‚ã«

è¨˜äº‹ã‚’æ›¸ãçµ‚ãˆã‚‹ç›´å‰ã«æ°—ãŒã¤ã„ãŸã®ã§ã™ãŒã€å…ˆäººãŒã™ã§ã«åŒæ§˜ã®è¶£æ—¨ã®è¨˜äº‹ã‚’æ›¸ã‹ã‚Œã¦ã„ã¾ã—ãŸã€‚ãã¡ã‚‰ã®è¨˜äº‹ã‚’èª­ã‚“ã§ã„ãŸã ã‘ã°ç§ã®è¨˜äº‹ã¯èª­ã¾ãªãã¦OKã§ã™ã€‚ã¨ã»ã»...ã€‚

- [Goã®ä¸¦åˆ—ãƒ†ã‚¹ãƒˆã§ã‚ˆãã‚ã‚‹ãƒã‚°ï¼ˆtt /= ttå¿˜ã‚Œï¼‰ã«å¯¾ã™ã‚‹å¯¾ç­– - Qiita](https://qiita.com/tenntenn/items/a003fe8774b82325e2df)

äºŒç•ªç…ã˜ã§ã‚‚ã‚ãªãŸã®ç…ã˜ãŸèŒ¶ãŒé£²ã¿ãŸã„ã€ã¨ã„ã†æ–¹ã¯æœ€å¾Œã¾ã§ãŠèª­ã¿ãã ã•ã„ã€‚

## å•é¡Œ

ã“ã“ã‹ã‚‰æœ¬é¡Œã§ã™ã€‚ä¾‹ãˆã°io.Writerã®æœ«å°¾ã«æ–‡å­—åˆ—Helloã‚’æ›¸ãè¾¼ã‚€AppendHelloé–¢æ•°ã‚’å®Ÿè£…ã—ãŸã¨ã—ã¾ã™ã€‚

```go
package example

import (
	"fmt"
	"io"
)

func AppendHello(dst io.Writer) error {
	n, err := io.WriteString(dst, `Hello`)

	if err != nil {
		return err
	}
	if n != 5 {
		return fmt.Errorf("unexpected written bytes count: %d", n)
	}

	return nil
}
```

## ï¼ˆç›´åˆ—ã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼‰æˆåŠŸ

ãƒ†ãƒ¼ãƒ–ãƒ«é§†å‹•ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```go
package example

import (
	"bytes"
	"testing"
)

func TestAppendHello(t *testing.T) {
	tests := []struct {
		name string
		arg  *bytes.Buffer
		want string
	}{
		{
			name: "one",
			arg:  bytes.NewBufferString("one"),
			want: "oneHello",
		},
		{
			name: "two",
			arg:  bytes.NewBufferString("two"),
			want: "twoHello",
		},
		{
			name: "three",
			arg:  bytes.NewBufferString("three"),
			want: "threeHello",
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			if err := AppendHello(tt.arg); err != nil {
				t.Fatal(err)
			}
			if got := tt.arg.String(); tt.want != got {
				t.Fatalf("expected: %q, actual: %q\n", tt.want, got)
			}
		})
	}
}
```

ãƒ†ã‚¹ãƒˆã¯æˆåŠŸã—ã¾ã™ã€‚ã“ã“ã¾ã§ã¯é †èª¿ã§ã™ã€‚

```console
$ go test
PASS
```

## ï¼ˆä¸¦åˆ—ã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼‰å¤±æ•—

ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¯å„ã€…ãŒç‹¬ç«‹ã—ã¦ã„ã‚‹ãŸã‚ä¸¦åˆ—ã«å®Ÿè¡Œã§ãã¾ã™ã€‚`t.Parallel()`ã‚’è¿½åŠ ã—ã¦ä¸¦åˆ—ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```go
for _, tt := range tests {
	t.Run(tt.name, func(t *testing.T) {
		t.Parallel()

		if err := AppendHello(tt.arg); err != nil {
			t.Fatal(err)
		}
		if got := tt.arg.String(); tt.want != got {
			t.Fatalf("expected: %q, actual: %q\n", tt.want, got)
		}
	})
}
```

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```console
$ go test
--- FAIL: TestAppendHello (0.00s)
    --- FAIL: TestAppendHello/two (0.00s)
        example_test.go:39: expected: "threeHello", actual: "threeHelloHelloHello"
```

å¤±æ•—ã—ã¾ã—ãŸã€‚ä½•ãŒèµ·ãã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ã€‚

## forãƒ«ãƒ¼ãƒ—ã¨goroutineã®ãŠã•ã‚‰ã„

ä»¥ä¸‹ã®ã‚ˆã†ã«forãƒ«ãƒ¼ãƒ—å†…ã§goroutineã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã©ã®ã‚ˆã†ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã§ã—ã‚‡ã†ã‹ã€‚

```go
package main

import (
	"fmt"
	"sync"
)

func main() {
	fruits := []string{"apple", "banana", "cherry"}

	var group sync.WaitGroup

	for _, fruit := range fruits {
		group.Add(1)

		go func() {
			fmt.Println(fruit)
			group.Done()
		}()
	}

	group.Wait()
}
```

çµæœã¯å¸¸ã«ã€Œcherryã€ãŒ3å›è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```console
$ go run main.go
cherry
cherry
cherry
```

goroutineã¯å®Ÿè¡Œã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§fruitå¤‰æ•°ã‚’å‚ç…§ã—ã¾ã™ã€‚ãã—ã¦ã€å„ã€…ã®goroutineãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ãã€ã™ã§ã«ãƒ«ãƒ¼ãƒ—ã¯çµ‚ã‚ã£ã¦ã„ã¾ã™ã€‚å¾“ã£ã¦ã€fruitå¤‰æ•°ã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹æ–‡å­—åˆ—ã€Œcherryã€ãŒ3å›è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

## testingãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®`t.Run()`ã¯ã©ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹

ã“ã“ã§testingãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®`t.Run()`ãŒã©ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```go
func (t *T) Run(name string, f func(t *T)) bool {
	// çœç•¥

	go tRunner(t, f)

	// çœç•¥
}
```

ãƒ†ãƒ¼ãƒ–ãƒ«é§†å‹•ãƒ†ã‚¹ãƒˆã‚’ä¸¦åˆ—ã«å®Ÿè¡Œã™ã‚‹ã¨å¤±æ•—ã™ã‚‹åŸå› ãŒåˆ¤æ˜ã—ã¾ã—ãŸã€‚`t.Run()`ã«æ¸¡ã—ãŸ`f`ãŒforãƒ«ãƒ¼ãƒ—å†…ã§goroutineã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

## è§£æ±ºç­–

ãªã«ãŒèµ·ãã¦ã„ã‚‹ã®ã‹æŠŠæ¡ã§ããŸã®ã§è§£æ±ºç­–ã‚’è€ƒãˆã¾ã—ã‚‡ã†ã€‚forãƒ«ãƒ¼ãƒ—å†…ã®goroutineã®å•é¡Œã«ã¤ã„ã¦ã¯2ã¤ã®è§£æ±ºç­–ãŒã‚ã‚Šã¾ã™ã€‚

- é©å½“ãªå¤‰æ•°ã«æŸç¸›ã™ã‚‹
- ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã®å¼•æ•°ã¨ã—ã¦æ¸¡ã™

### é©å½“ãªå¤‰æ•°ã«æŸç¸›ã™ã‚‹

ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚

```go
package main

import (
	"fmt"
	"sync"
)

func main() {
	fruits := []string{"apple", "banana", "cherry"}

	var group sync.WaitGroup

	for i := range fruits {
		fruit := fruits[i]

		group.Add(1)

		go func() {
			fmt.Println(fruit)
			group.Done()
		}()
	}

	group.Wait()
}
```

### ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã®å¼•æ•°ã¨ã—ã¦æ¸¡ã™

ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚

```go
package main

import (
	"fmt"
	"sync"
)

func main() {
	fruits := []string{"apple", "banana", "cherry"}

	var group sync.WaitGroup

	for _, fruit := range fruits {
		group.Add(1)

		go func(s string) {
			fmt.Println(s)
			group.Done()
		}(fruit)
	}

	group.Wait()
}
```

### ã©ã¡ã‚‰ã®è§£æ±ºç­–ã‚’é¸ã¶ã¹ãã‹

ã©ã¡ã‚‰ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚‚goroutineãŒå®Ÿè¡Œã•ã‚Œã‚‹ç’°å¢ƒã«å¤‰æ•°ã‚’æŸç¸›ã—ã¦ã„ã‚‹ã“ã¨ã«å¤‰ã‚ã‚Šãªã„ã®ã§ã€ã©ã¡ã‚‰ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚ä»Šå›ã®ãƒ†ãƒ¼ãƒ–ãƒ«é§†å‹•ãƒ†ã‚¹ãƒˆã®ä¾‹ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ•°ã‚’æŸç¸›ã™ã‚‹ã®ãŒæœ€ã‚‚æ‰‹è»½ãªè§£æ±ºç­–ã‹ã¨æ€ã„ã¾ã™ã€‚

```go
for i := range tests {
	tt := tests[i]

	t.Run(tt.name, func(t *testing.T) {
		t.Parallel()

		if err := AppendHello(tt.arg); err != nil {
			t.Fatal(err)
		}
		if got := tt.arg.String(); tt.want != got {
			t.Fatalf("expected: %q, actual: %q\n", tt.want, got)
		}
	})
}
```

## go vetã‚„golangci-lintã§ãƒŸã‚¹ã‚’é˜²ã

testingãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚ˆãèª­ã‚“ã§ã„ã‚Œã°ãƒŸã‚¹ã¯é˜²ã’ãŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã—ã‹ã—ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†…å®¹ãŒå¸¸ã«æ­£ã—ã„ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚ã‹ã¨ã„ã£ã¦æ¯å›å®Ÿè£…ã®è©³ç´°ã‚’è¿½ã„ã‹ã‘ã‚‹ã®ã¯éª¨ãŒæŠ˜ã‚Œã¾ã™ã€‚

ãã“ã§å½¹ã«ç«‹ã¤ã®ãŒ`go vet`ã§ã™ã€‚`go vet`ã‚’å®Ÿè¡Œã™ã‚Œã°å®Ÿè£…ã®ãƒŸã‚¹ã«æ°—ãŒã¤ãã“ã¨ãŒã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€ä¿®æ­£å‰ã®ä¸¦åˆ—ç‰ˆTestAppendHelloã®å®Ÿè£…ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªè­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```console
$ go vet
# example
./example_test.go:35:26: loop variable tt captured by func literal
./example_test.go:38:14: loop variable tt captured by func literal
./example_test.go:38:31: loop variable tt captured by func literal
./example_test.go:39:44: loop variable tt captured by func literal
```

ä¸Šè¨˜ã¯è¨˜äº‹ã‚’æŠ•ç¨¿ã—ãŸæ™‚ç‚¹ã§æœ€æ–°ã®go 1.20.1ã§å®Ÿè¡Œã—ãŸçµæœã«ãªã‚Šã¾ã™ã€‚ãã®ä»–ã€`golangci-lint`ãªã©`go vet`ã«æº–ãšã‚‹ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã‚‚ãƒŸã‚¹ã«æ°—ãŒã¤ãã“ã¨ãŒã§ãã¾ã™ã€‚
