---
title: "Cloudflare WorkersにNext.jsアプリをデプロイする"
emoji: "💭"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Cloudflare, Nextjs]
published: false
---
## はじめに

2024年9月にWorkers Static Assets機能がリリースされ、フルスタックなNext.jsアプリケーションがデプロイ可能になりました。記事投稿時点でまだ実験的機能の扱いですが、動作するか試してみます。

## プロジェクトを作成する

以下のコマンドを実行してプロジェクトを作成します。デプロイは後で行うため、「Do you want to deploy your application?」はNoと回答してください。

```console
npm create cloudflare@latest my-next-app -- --framework=next --experimental
```

### （補足）package.jsonについて

記事を投稿した時点では以下のようなpackage.jsonが生成されます。Cloudflareのドキュメントにはpackage.jsonのscriptsを修正するように指示されていますが、修正は不要です。

```json
{
  "name": "my-next-app",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "deploy": "opennextjs-cloudflare && wrangler deploy",
    "preview": "opennextjs-cloudflare && wrangler dev",
    "cf-typegen": "wrangler types --env-interface CloudflareEnv env.d.ts"
  },
  "dependencies": {
    "next": "14.2.5",
    "react": "^18",
    "react-dom": "^18"
  },
  "devDependencies": {
    "@cloudflare/workers-types": "^4.20250109.0",
    "@opennextjs/cloudflare": "^0.3.7",
    "@types/node": "^20",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "eslint": "^8",
    "eslint-config-next": "14.2.5",
    "postcss": "^8",
    "tailwindcss": "^3.4.1",
    "typescript": "^5",
    "wrangler": "^3.101.0"
  }
}
```

## デプロイする

ひとまずデプロイが成功するか確認します。以下のコマンドを実行してください。

```console
npm run deploy
```

警告やエラーは発生せずデプロイは成功するはずです。ブラウザで`https://my-next-app.<your_name>.workers.dev`を開いてみてください。

:::details 実行結果の例

参考までに実行時のログを示します。

```console
$ npm run deploy

> my-next-app@0.1.0 deploy
> opennextjs-cloudflare && wrangler deploy


┌─────────────────────────────┐
│ OpenNext — Cloudflare build │
└─────────────────────────────┘

App directory: /private/tmp/my-next-app
Next.js version : 14.2.5
OpenNext v3.3.1

┌─────────────────────────────────┐
│ OpenNext — Building Next.js app │
└─────────────────────────────────┘


> my-next-app@0.1.0 build
> next build

  ▲ Next.js 14.2.5

   Creating an optimized production build ...
(node:50071) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
(node:50120) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
 ✓ Compiled successfully
 ✓ Linting and checking validity of types
 ✓ Collecting page data
 ✓ Generating static pages (5/5)
 ✓ Collecting build traces
 ✓ Finalizing page optimization

Route (app)                              Size     First Load JS
┌ ○ /                                    5.23 kB        92.3 kB
└ ○ /_not-found                          875 B          87.9 kB
+ First Load JS shared by all            87 kB
  ├ chunks/23-b75664ace61c0abb.js        31.5 kB
  ├ chunks/fd9d1056-2821b0f0cabcd8bd.js  53.7 kB
  └ other shared chunks (total)          1.85 kB


○  (Static)  prerendered as static content


┌──────────────────────────────┐
│ OpenNext — Generating bundle │
└──────────────────────────────┘

Bundling middleware function...
Bundling static assets...
Bundling cache assets...
Building server function: default...
# copyPackageTemplateFiles
⚙️ Bundling the OpenNext server...

# patchWranglerDeps
# updateWebpackChunksFile
 - chunk 347.js
 - chunk 682.js
 - chunk 948.js
Applying code patches:
 - patching require
 - patching `buildId` function
 - patching `loadManifest` function
 - patching next's require
 - patching `findDir` function
 - patching `evalManifest` function
 - patching cacheHandler
 - patching 'require(this.middlewareManifestPath)'
 - patching exception bubbling
 - patching `loadInstrumentationModule` function
 - patching `patchAsyncStorage` call
 - patching `eval("require")` calls
 - patching `require.resolve` call
All 13 patches applied

Worker saved in `/private/tmp/my-next-app/.open-next/worker.js` 🚀

OpenNext build complete.

 ⛅️ wrangler 3.101.0
--------------------

🌀 Building list of assets...
🌀 Starting asset upload...
🌀 Found 31 new or modified static assets to upload. Proceeding with upload...
+ /BUILD_ID
+ /_next/static/3IkHGSNZNy73_7lkbfk4L/_buildManifest.js
+ /_next/static/chunks/app/layout-cacac135ce820ae3.js
+ /next.svg
+ /_next/static/chunks/webpack-d0ceac4fb78a3613.js
+ /cnd-cgi/_next_cache/3IkHGSNZNy73_7lkbfk4L/_not-found.cache
+ /_next/static/media/26a46d62cd723877-s.woff2
+ /_next/static/media/55c55f0601d81cf3-s.woff2
+ /_next/static/media/6d93bde91c0c2823-s.woff2
+ /cnd-cgi/_next_cache/3IkHGSNZNy73_7lkbfk4L/favicon.ico.cache
+ /_next/static/chunks/fd9d1056-2821b0f0cabcd8bd.js
+ /_next/static/3IkHGSNZNy73_7lkbfk4L/_ssgManifest.js
+ /_next/static/chunks/pages/_error-1be831200e60c5c0.js
+ /_next/static/chunks/main-app-8cc085c9d52c8c97.js
+ /_next/static/chunks/app/_not-found/page-05886c10710171db.js
+ /_next/static/media/df0a9ae256c0569c-s.woff2
+ /_next/static/chunks/173-32f9ff9bdfb525b3.js
+ /_next/static/media/581909926a08bbc8-s.woff2
+ /favicon.ico
+ /_next/static/chunks/polyfills-78c92fac7aa8fdd8.js
+ /_next/static/chunks/23-b75664ace61c0abb.js
+ /_next/static/chunks/app/page-41ceab464b24ef75.js
+ /_next/static/chunks/pages/_app-6a626577ffa902a4.js
+ /vercel.svg
+ /cnd-cgi/_next_cache/3IkHGSNZNy73_7lkbfk4L/500.cache
+ /_next/static/media/97e0cb1ae144a2a9-s.woff2
+ /_next/static/css/f451d9dd0f2d5d98.css
+ /cnd-cgi/_next_cache/3IkHGSNZNy73_7lkbfk4L/index.cache
+ /_next/static/media/a34f9d1faa5f3315-s.p.woff2
+ /_next/static/chunks/main-c8553ba68b419844.js
+ /_next/static/chunks/framework-f66176bb897dc684.js
Uploaded 10 of 31 assets
Uploaded 20 of 31 assets
Uploaded 31 of 31 assets
✨ Success! Uploaded 31 files (6.85 sec)

Total Upload: 5238.56 KiB / gzip: 1355.74 KiB
Worker Startup Time: 92 ms
Uploaded my-next-app (23.24 sec)
Deployed my-next-app triggers (0.90 sec)
  https://my-next-app.moutend.workers.dev
Current Version ID: 35c1e4fb-0e51-43ea-92ed-4da5154b8b41
```

:::
