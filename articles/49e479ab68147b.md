---
title: "ï¼ˆSwiftï¼‰iPhoneã§Create MLã®MLImageClassifierã‚’ç”¨ã„ã¦ç”»åƒåˆ†é¡ãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´ã¨æ¨è«–ã‚’è¡Œã†"
emoji: "ğŸ“"
type: "tech"
topics: [Apple, iOS, Swift, CreateML, æ©Ÿæ¢°å­¦ç¿’]
published: false
---
## ã¯ã˜ã‚ã«

iPhoneã§Create MLã®MLImageClassifierã‚’ç”¨ã„ã¦ç”»åƒåˆ†é¡ãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´ã¨æ¨è«–è¡Œã†ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¾ã—ãŸã€‚iOS 15ä»¥ä¸Šã®ãƒ‡ãƒã‚¤ã‚¹ã§å‹•ä½œã—ã¾ã™ã€‚

https://github.com/moutend/TrainingMLImageClassifier

è¨“ç·´æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã®`.mlmodel`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ—ãƒªã«åŸ‹ã‚è¾¼ã‚€ä¾‹ã¯ã‚ˆãè¦‹ã‹ã‘ã¾ã™ãŒã€ãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´ã‹ã‚‰æ¨è«–ã¾ã§ã‚’iPhoneä¸Šã§å®Œçµã•ã›ã‚‹ä¾‹ã¯ã‚ã¾ã‚Šè¦‹ã‹ã‘ã¾ã›ã‚“ã€‚ã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹ã§å‡¦ç†ã™ã‚‹ä¸€ä¾‹ã¨ã—ã¦å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

## ä¸å…·åˆã¨æ€ã‚ã‚Œã‚‹äº‹è±¡ã®å ±å‘Š

ã•ã¦æœ¬é¡Œã«é€²ã¿ãŸã„ã¨ã“ã‚ã§ã™ãŒã€ä¸å…·åˆã¨æ€ã‚ã‚Œã‚‹äº‹è±¡ã«é­é‡ã—ãŸã®ã§å…±æœ‰ã—ã¾ã™ã€‚å®Ÿè£…ã®è¦ç‚¹ã ã‘çŸ¥ã‚ŠãŸã„å ´åˆã€èª­ã¿é£›ã°ã—ã¦ã„ãŸã ã„ã¦æ§‹ã„ã¾ã›ã‚“ã€‚

### 1. è¨“ç·´ãŒæ¥µç«¯ã«é…ããªã‚‹äº‹è±¡ã«ã¤ã„ã¦

åŸå› ã¯ä¸æ˜ã§ã™ãŒã€iOS 17ã§ãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´ã«ã‹ã‹ã‚‹æ™‚é–“ãŒæ¥µç«¯ã«é…ããªã‚‹äº‹è±¡ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯iOS 15ã¨æ¯”è¼ƒã—ã¦3å€ã»ã©é…ããªã‚Šã¾ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚’ä¾‹ã«ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœã«ãªã‚Šã¾ã—ãŸã€‚

- iOS 15ã¨iPhone 13ã®çµ„ã¿åˆã‚ã›â†’9.8ç§’
- iOS 17ã¨iPhone 15 Proã®çµ„ã¿åˆã‚ã›â†’29.9ç§’

Appleã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€iPhone 13ã«æ­è¼‰ã•ã‚Œã¦ã„ã‚‹A15 Bionicãƒãƒƒãƒ—ã®æ€§èƒ½ã¯15.8 TFLOPSã§ã™ã€‚iPhone 15 Proã«æ­è¼‰ã•ã‚Œã¦ã„ã‚‹A17 Proãƒãƒƒãƒ—ã®TFLOPSæ€§èƒ½ã¯å…¬è¡¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€A15ä¸–ä»£ã¨æ¯”è¼ƒã—ã¦2å€ã®æ€§èƒ½ã ãã†ã§ã™ã€‚

å¾“ã£ã¦ã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã§ã¯ãªãiOSã«åŸå› ãŒã‚ã‚Šãã†ã§ã™ã€‚Create MLãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®å†…éƒ¨çš„ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚Œã¦è¨“ç·´ãŒé…ããªã£ã¦ã„ã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãªãŠæ¨è«–ã«ã‹ã‹ã‚‹æ™‚é–“ã¯iPhone 15ä¸–ä»£ã®æ–¹ãŒé«˜é€Ÿã§ã™ã€‚

æ®‹å¿µãªãŒã‚‰è§£æ±ºç­–ã¯è¦‹ã¤ã‘ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€ã²ã¨ã¾ãšäº‹è±¡ã®å…±æœ‰ã§ã—ãŸã€‚ã‚‚ã—ä½•ã‹ã”å­˜çŸ¥ã®æ–¹ãŒã„ã¾ã—ãŸã‚‰ã€ã‚³ãƒ¡ãƒ³ãƒˆãªã©ã§æ•™ãˆã¦ã„ãŸã ã‘ãŸã‚‰å¹¸ã„ã§ã™ã€‚

### 2. è¨“ç·´ä¸­ã®ã‚¨ãƒ©ãƒ¼ã€ŒMust allow 2048-element vector as outputã€ã«ã¤ã„ã¦

iOS 17ãŒæ­è¼‰ã•ã‚ŒãŸãƒ‡ãƒã‚¤ã‚¹ã§ãƒ¢ãƒ‡ãƒ«ã‚’è¨“ç·´ã™ã‚‹ã¨ã€Xcodeã®Debug Consoleã«ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦å‡¦ç†ãŒä¸­æ–­ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

```text
MLModelAsset: load failed with error Error Domain=com.apple.CoreML Code=0 "Must allow 2048-element vector as output" UserInfo={NSLocalizedDescription=Must allow 2048-element vector as output}
```

ãŠãã‚‰ãAppleã®å®Ÿè£…ãƒŸã‚¹ãŒã‚¨ãƒ©ãƒ¼ã®åŸå› ã§ã™ã€‚ã“ã®ã‚¨ãƒ©ãƒ¼ã¯`MLImageClassifier.FeatureExtractorType.scenePrint(revision: nil)`ã®ã‚ˆã†ã«ã€ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·ã«`nil`ã‚’æŒ‡å®šã™ã‚‹ã¨ç™ºç”Ÿã—ã¾ã™ã€‚

Apple Developerã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·ã¨ã—ã¦`nil`ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã¯æœ€æ–°ã®ç•ªå·ãŒæŒ‡å®šã•ã‚ŒãŸã‚‚ã®ã¨ã—ã¦æ‰±ã†ã¨èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

> The sceneprint version. The supported versions include 1 and 2. If nil defaults to the latest version.
> 
> å¼•ç”¨å…ƒ https://developer.apple.com/documentation/createml/mlimageclassifier/featureextractortype/sceneprint(revision:)

ã—ã‹ã—ã€iOS 17ã§ã¯`nil`ã‚’æŒ‡å®šã™ã‚‹ã¨ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚ã“ã®ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹ã«ã¯ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·ã¨ã—ã¦`1`ã‹`2`ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚

ãªãŠã€ã“ã®ã‚¨ãƒ©ãƒ¼ã¯iOS 15ã§ã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯å®Ÿè£…ã®è¦ç‚¹ã§æ”¹ã‚ã¦èª¬æ˜ã—ã¾ã™ã€‚

## ã“ã®è¨˜äº‹ã«ã¤ã„ã¦

Create MLã®MLImageClassifierã®åˆ©ç”¨æ–¹æ³•ã«ã¤ã„ã¦ã¯ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚’ã”ç¢ºèªãã ã•ã„ã€‚`Logic/ImageTrainer.swift`ãŒè¨“ç·´ã€`Logic/ImageClassifier.swift`ãŒæ¨è«–ã®å®Ÿè£…ã«ãªã‚Šã¾ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯å®Ÿè£…ã®è¦ç‚¹ã‚„é–‹ç™ºä¸­ã«ç”Ÿã˜ã‚‹ç–‘å•ã«ã¤ã„ã¦ãŠç­”ãˆã—ã¾ã™ã€‚ãã‚‚ãã‚‚Create MLãŒå°‚é–€çŸ¥è­˜ãªã—ã§æ‰‹è»½ã«æ‰±ãˆã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã®ã§ã€æ©Ÿæ¢°å­¦ç¿’ã«ã¤ã„ã¦ã®å‰æçŸ¥è­˜ã¯ä¸è¦ã§ã™ã€‚

ãŸã ã—ã€æ©Ÿæ¢°å­¦ç¿’ã®å…¥é–€ã‚’æ¸ˆã¾ã›ã¦ãŠãã¨è¨˜äº‹ã‚’æ—©ãèª­ã¿é€²ã‚ã‚‰ã‚Œã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚ä¾‹ãˆã°æ›¸ç±ã€Œã‚¼ãƒ­ã‹ã‚‰ä½œã‚‹Deep Learningã€ãŒãŠã™ã™ã‚ã§ã™ã€‚éš…ã‹ã‚‰éš…ã¾ã§èª­ã¿è¾¼ã‚€å¿…è¦ã¯ãªãã€æ¦‚è¦ã‚’æŠŠæ¡ã™ã‚‹ã ã‘ã§ã‚‚ååˆ†ã§ã™ã€‚

- [O'Reilly Japan - ã‚¼ãƒ­ã‹ã‚‰ä½œã‚‹Deep Learning](https://www.oreilly.co.jp/books/9784873117584/)

## è¨“ç·´ã‹ã‚‰æ¨è«–ã¾ã§ã®æµã‚Œ

ãã‚Œã§ã¯Create MLã‚’åˆ©ç”¨ã—ã¦ç”»åƒåˆ†é¡å™¨ã‚’ä½œæˆãƒ»åˆ©ç”¨ã™ã‚‹æµã‚Œã‚’èª¬æ˜ã—ã¾ã™ã€‚æ‰‹é †ã¯ä»¥ä¸‹ã®3ã‚¹ãƒ†ãƒƒãƒ—ã§ã™ã€‚

1. è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„ã—ã¾ã™ã€‚å…·ä½“çš„ã«ã¯FileManagerã§ä»»æ„ã®å ´æ‰€ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãã®ä¸­ã«ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã™ã€‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®åå‰ãŒåˆ†é¡ãƒ©ãƒ™ãƒ«ã®åå‰ã«ãªã‚Šã¾ã™ã€‚
2. è«¸ã€…ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¦è¨“ç·´ã‚’é–‹å§‹ã—ã¾ã™ã€‚è¨“ç·´ãŒå®Œäº†ã™ã‚‹ã¨`.mlmodel`ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
3. ä½œæˆã—ãŸ`.mlmodel`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¾ã™ã€‚ãã®å¾Œã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨æ¨è«–ãŒå¯èƒ½ãªçŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚

Create MLã®ãŠæ‰‹è»½ã•ãŒä¼ã‚ã£ãŸã§ã—ã‚‡ã†ã‹ã€‚

ã¨ã¯ã„ãˆã€ã“ã®æ™‚ç‚¹ã§ç–‘å•ãŒç”Ÿã¾ã‚Œã¾ã™ã€‚

- iPhoneã¯ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚„ãƒ¡ãƒ¢ãƒªãªã©ãƒªã‚½ãƒ¼ã‚¹ãŒé™ã‚‰ã‚Œã¦ã„ã‚‹ã€‚è¨“ç·´ãƒ‡ãƒ¼ã‚¿ï¼ˆç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã®ã‚µã‚¤ã‚ºã‚„åˆ†é¡ãƒ©ãƒ™ãƒ«ã®å€‹æ•°ã«åˆ¶é™ã¯ã‚ã‚‹ã®ã‹ï¼Ÿ
- è¨“ç·´ã«ã¯ã©ã‚Œãã‚‰ã„æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã‹ï¼Ÿè¨“ç·´ä¸­ã®ãƒªã‚½ãƒ¼ã‚¹æ¶ˆè²»ã¯ã©ã‚Œãã‚‰ã„ã‹ï¼Ÿ
- Macã¨iPhoneã§è¨“ç·´ã®å†…å®¹ã¯ç•°ãªã‚‹ã®ã‹ï¼ŸåŒã˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã—ã¦è¨“ç·´ã—ãŸå ´åˆã€æœ€çµ‚çš„ã«ä½œæˆã•ã‚Œã‚‹`.mlmodel`ãƒ•ã‚¡ã‚¤ãƒ«ã«é•ã„ã¯ã‚ã‚‹ã®ã‹ï¼Ÿ
- ãƒ¢ãƒ‡ãƒ«ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã¯ã©ã‚Œãã‚‰ã„æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã‹ï¼Ÿã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã®å®¹é‡ã¯ã©ã‚Œãã‚‰ã„ã‹ï¼Ÿ
- æ¨è«–ã«ã¯ã©ã‚Œãã‚‰ã„æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã‹ï¼Ÿæ¨è«–ã®ãŸã³ã«éƒ½åº¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒå¿…è¦ãªã®ã‹ï¼Ÿã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’åˆ¥ã®ãƒ‡ãƒã‚¤ã‚¹ã§å†åˆ©ç”¨ã§ãã‚‹ã®ã‹ï¼Ÿ

ä¸Šè¨˜ã®ç–‘å•ã«ã¤ã„ã¦ã¯è¨˜äº‹ã®å¾ŒåŠã§ãŠç­”ãˆã—ã¾ã™ã€‚

## å®Ÿè£…ã®è¦ç‚¹

ã“ã“ã‹ã‚‰ã¯å®Ÿè£…ã®è¦ç‚¹ã‚’èª¬æ˜ã—ã¾ã™ã€‚é …ç›®ã¯ä»¥ä¸‹ã®5ã¤ã§ã™ã€‚

1. å®Ÿè³ªçš„ã«ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ãƒ¢ãƒ‡ãƒ«ã—ã‹é¸æŠè‚¢ãŒãªã„
2. ModelParametersã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æ³¨æ„
3. MLTrainingSessionParametersã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æ³¨æ„
4. MLJobã®checkpointsãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§è¨“ç·´ã®é€²æ—ã‚’å–å¾—ã™ã‚‹ã«ã¯MLImageClassifierã®`train()`ã«sessionParameterså¼•æ•°ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
5. MLJobã®resultãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§è¨“ç·´ãŒå®Œäº†ã—ãŸéš›ã®çµæœã‚’å—ã‘å–ã‚‹ã«ã¯AnyCancellableã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã€‚

### 1. å®Ÿè³ªçš„ã«ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ãƒ¢ãƒ‡ãƒ«ã—ã‹é¸æŠè‚¢ãŒãªã„

ç”»åƒåˆ†é¡ã«åˆ©ç”¨ã§ãã‚‹ãƒ¢ãƒ‡ãƒ«ã¯å®Ÿè³ªçš„ã«ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ãƒ¢ãƒ‡ãƒ«ã®ã¿ã§ã™ã€‚Apple Developerãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰å¼•ç”¨ã—ã¾ã™ã€‚

> `case logisticRegressor` -- Logistic regression is a statistical model that classifies input feature vector into different categories.
> `case multilayerPerceptron(layerSizes: [Int])` -- Multilayer perceptron, layerSizes holds a list of positive integers that represent the number of hidden units in each layer. An additional fully connected layer with a Softmax activation output will be added that maps to probabilities of sound categories.
> 
> å¼•ç”¨å…ƒ https://developer.apple.com/documentation/createml/mlimageclassifier/modelparameters-swift.struct/classifiertype

ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ãƒ¢ãƒ‡ãƒ«ã¯æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®ä¸€ç¨®ã§ã™ã€‚æµè¡Œã‚Šã®ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç™»å ´ä»¥å‰ã‹ã‚‰ã‚ã‚‹ã€æŠ€è¡“çš„ã«æ¯ã‚ŒãŸæ‰‹æ³•ã§ã™ã€‚

ç¾çŠ¶ã®Create MLã¯2ã¤ã®é¸æŠè‚¢ãŒã‚ã‚Šã€1ç•ªç›®ã®`logisticRegressor`ãŒãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚2ç•ªç›®ã®`multilayerPerceptron`ãŒãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’åˆ©ç”¨ã—ãŸãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚ã—ã‹ã—ã€2ç•ªç›®ã®èª¬æ˜ã‚’æœ€å¾Œã¾ã§èª­ã‚€ã¨éŸ³å£°ã‚’åˆ†é¡ã™ã‚‹ãŸã‚ã€ã¨æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

ã¤ã¾ã‚Šã€2ç•ªç›®ã®é¸æŠè‚¢ã¯ç”»åƒå‡¦ç†ã§ã‚ˆãä½¿ã‚ã‚Œã‚‹ç•³ã¿è¾¼ã¿ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã‚ˆã†ãªãƒ¢ãƒ‡ãƒ«ã§ã¯ãªãã€æ–‡å­—é€šã‚Šãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é‡ã­ãŸã ã‘ã®ç´ æœ´ãªãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚ä½•ã«ã§ã‚‚ä½¿ãˆã‚‹ã®ã§ã€ã¨ã‚Šã‚ãˆãšé¸æŠè‚¢ã¨ã—ã¦å«ã¾ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

ä½™è«‡ã«ãªã‚Šã¾ã™ãŒã€æ›¸ç±ã€Œã‚¼ãƒ­ã‹ã‚‰ä½œã‚‹Deep Learningã€ã§ã¯ç´ æœ´ãª2å±¤ã®ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç”¨ã„ã¦MNISTç”»åƒã®åˆ†é¡æ°—ã‚’å®Ÿè£…ã™ã‚‹ä¾‹ãŒç™»å ´ã—ã¾ã™ã€‚ãã‚Œãªã‚Šã«æ©Ÿèƒ½ã™ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¦ãŠã‚‚ã—ã‚ã„å®Ÿé¨“ã§ã™ã€‚

### 2. ModelParametersã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æ³¨æ„

MLImageClassifier.ModelParametersã«ã¤ã„ã¦ã®è©±ã§ã™ã€‚ã¾ãšã¯`init()`ã®å®šç¾©ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```swift
init(
  validation: MLImageClassifier.ModelParameters.ValidationData = __Defaults.validation,
  maxIterations: Int = __Defaults.maximumIterations,
  augmentation: MLImageClassifier.ImageAugmentationOptions,
  algorithm: MLImageClassifier.ModelParameters.ModelAlgorithmType = __Defaults.algorithm
)
```

å¼•æ•°ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

- validation: `.split(strategy: .automatic)`
- maxIterations: `25`
- augmentation: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãªã—
- algorithm: `.transferLearning(featureExtractor: .scenePrint(revision: 1), classifier: .logisticRegressor)`

ãã‚Œãã‚Œã®å¼•æ•°ã®å½¹å‰²ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

- validation: æ©Ÿæ¢°å­¦ç¿’ã§ã¯æ±åŒ–èƒ½åŠ›ã‚’ç²å¾—ã•ã›ã‚‹ãŸã‚ã€è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã¨ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’åˆ†å‰²ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚validationã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•çš„ã«è‰¯ã„å¡©æ¢…ã§åˆ†å‰²ã™ã‚‹ã“ã¨ã‚’æŒ‡ç¤ºã—ã¾ã™ã€‚é€šå¸¸ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®ã¾ã¾ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
- maxIterations: è¨“ç·´ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¹°ã‚Šè¿”ã™å›æ•°ã®æœ€å¤§å€¤ã‚’æ„å‘³ã—ã¾ã™ã€‚25ã¨ã„ã†æ•°å€¤ã«ã¯ç‰¹ã«æ ¹æ‹ ãŒãªãã€ãŠãã‚‰ãä»®ã®å€¤ã¨ã—ã¦ç½®ã‹ã‚Œã¦ã„ã‚‹ã ã‘ã§ã™ã€‚ã“ã®å€¤ã¯å„è‡ªã§èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
- augmentation: è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã®æ°´å¢—ã—ã‚’è¡Œã†ã‹æŒ‡ç¤ºã—ã¾ã™ã€‚ç”»åƒã®ã¼ã‹ã—ã‚„å‚¾ãã‚’åŠ ãˆã‚‹ã“ã¨ã‚’æŒ‡ç¤ºã§ãã¾ã™ãŒã€ã©ã‚Œãã‚‰ã„ãƒœã‚±ã‚’åŠ ãˆã‚‹ã®ã‹ã‚„å‚¾æ–œã®è§’åº¦ãªã©ç´°ã‹ãªæŒ‡ç¤ºã¯ã§ãã¾ã›ã‚“ã€‚
- algorithm: ãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´ã«ä½¿ç”¨ã™ã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’æŒ‡å®šã—ã¾ã™ã€‚enumã§é¸æŠè‚¢ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ãŒã€ä»Šã®ã¨ã“ã‚åˆ©ç”¨ã§ãã‚‹ã®ã¯ã“ã®é¸æŠè‚¢ã®ã¿ã§ã™ã€‚ã‚ã‚‹ã„ã¯è‡ªåˆ†ã§ç‰¹å¾´é‡ã®æŠ½å‡ºæ–¹æ³•ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

scenePrintã®revisionç•ªå·ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯`1`ã«ãªã£ã¦ã„ã¾ã™ãŒã€ç¾åœ¨ã¯`2`ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚ãªãŠãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã§ã¯ãªã`nil`ã‚’æŒ‡å®šã™ã‚‹ã¨å¸¸ã«æœ€æ–°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’æŒ‡ç¤ºã§ãã¾ã™ã€‚

ä»¥ä¸Šã‚’è¸ã¾ãˆãŸä¸Šã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹ã¨ã€ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```swift
let parameters = MLImageClassifier.ModelParameters(
  validation: .split(strategy: .automatic),
  maxIterations: 50,
  augmentation: [],
  algorithm: .transferLearning(
    featureExtractor: .scenePrint(revision: nil),
    classifier: .logisticRegressor
  )
)
```

### 3. MLTrainingSessionParametersã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æ³¨æ„

MLImageClassifierã®ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰`train()`ã«ã¤ã„ã¦ã®è©±ã§ã™ã€‚ã‚·ã‚°ãƒãƒãƒ£ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

```swift
static func train(
  trainingData: MLImageClassifier.DataSource,
  parameters: MLImageClassifier.ModelParameters = ModelParameters(
      validation: .split(strategy: .automatic),
      augmentation: [],
      algorithm: .transferLearning(
        featureExtractor: .scenePrint(revision: 1),
        classifier: .logisticRegressor
      )
    ),
  sessionParameters: MLTrainingSessionParameters = _defaultSessionParameters
) throws -> MLJob<MLImageClassifier>
```

ã“ã“ã§å¼•æ•°`sessionParameters`ã«æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ãŒã€å…·ä½“çš„ã«ã©ã®ã‚ˆã†ãªå€¤ãªã®ã‹Apple Developerã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«èª¬æ˜ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

ç¶šã„ã¦`MLTrainingSessionParameters`ã®`init()`ãŒã©ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```swift
init(
  sessionDirectory: URL? = nil,
  reportInterval: Int = 5,
  checkpointInterval: Int = 10,
  iterations: Int = 1000
)
```

ã•ã¦ã€`_defaultSessionParameters`ã¨MLTrainingSessionParametersã®`init()`ãŒè¿”ã™å€¤ã¯åŒã˜ãªã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ç­”ãˆã¯NOã§ã™ã€‚ä¸¡è€…ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯ç•°ãªã‚Šã¾ã™ã€‚

ã©ã®ã‚ˆã†ãªã‚¢ãƒ—ãƒªã‚’å®Ÿè£…ã™ã‚‹ã‹ã«ä¾å­˜ã—ã¾ã™ãŒã€ãŠãã‚‰ã`init()`ãŒè¿”ã™ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯é€šå¸¸ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯é »åº¦ãŒç´°ã‹ã™ãã‚‹ä¸Šã«ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å›æ•°ãŒå¤šã™ãã¾ã™ã€‚ç‰¹ã«ç†ç”±ãŒãªã‘ã‚Œã°`train()`ã®`sessionParameters`ã¯çœç•¥ã—ã¦å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

### 4. MLJobã®checkpointsãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§è¨“ç·´ã®é€²æ—ã‚’å–å¾—ã™ã‚‹ã«ã¯MLImageClassifierã®`train()`ã«sessionParameterså¼•æ•°ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹

MLImageClassifierã®`train()`ã§è¨“ç·´ã‚’é–‹å§‹ã—ãŸå ´åˆã®è©±ã§ã™ã€‚`sessionParameters`ã¯çœç•¥ã™ã‚‹ã®ãŒãŠã™ã™ã‚ã¨èª¬æ˜ã—ã¾ã—ãŸãŒã€ãã†ã™ã‚‹ã¨è¨“ç·´ã®é€²æ—ãŒå–å¾—ã§ããªããªã‚Šã¾ã™ã€‚è¨“ç·´ã«ç›¸å½“ãªæ™‚é–“ãŒå¿…è¦ã«ãªã‚‹ã¨è¦‹è¾¼ã¾ã‚Œã‚‹å ´åˆã¯`sessionParameters`ã‚’è¨­å®šã—ã¦ã€MLJobã®checkpointsã§é€²æ—ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚

ãªãŠ`sessionParameters`ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜ã™ã‚‹ã‚ˆã†ã«æŒ‡ç¤ºã™ã‚‹å ´åˆã€è¨“ç·´é€”ä¸­ã«ä¸­æ–­ã™ã‚‹ã‚±ãƒ¼ã‚¹ã®è€ƒæ…®ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚å…·ä½“çš„ã«ã¯MLTrainingSessionParametersã®`sessionDirectory`ã§æŒ‡ç¤ºã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¨˜éŒ²ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒæ®‹ã‚Šã¾ã™ã€‚

ã“ã®çŠ¶æ…‹ã§å†åº¦MLImageClassifierã®`train()`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚é€”ä¸­ã‹ã‚‰ã§ã¯ãªãè¨“ç·´ã‚’æœ€åˆã‹ã‚‰å†å®Ÿè¡Œã—ãŸã„å ´åˆã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¨˜éŒ²ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### 5. MLJobã®resultãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§è¨“ç·´ãŒå®Œäº†ã—ãŸéš›ã®çµæœã‚’å—ã‘å–ã‚‹ã«ã¯AnyCancellableã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹

Create MLã¨ã¯é–¢ä¿‚ã®ãªã„è©±é¡Œã§ã™ãŒã€AnyPublisherå‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰å€¤ã‚’å–å¾—ã™ã‚‹å ´åˆã®è©±ã§ã™ã€‚Publisherã¯Combineãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒæä¾›ã™ã‚‹ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿæ§‹ã§ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

- [Combine - Apple Developer Documentation](https://developer.apple.com/documentation/combine)
- [Publisher - Apple Developer Documentation](https://developer.apple.com/documentation/combine/publisher)
- [AnyPublisher - Apple Developer Documentation](https://developer.apple.com/documentation/Combine/AnyPublisher)
- [AnyCancellable - Apple Developer Documentation](https://developer.apple.com/documentation/combine/anycancellable)

ãªãŠã€MLJobã®è¨“ç·´ã‚’ä¸­æ–­ã—ãŸã„å ´åˆã¯MLJobã®`cancel()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

å®Ÿè£…ä¾‹

```swift
// å‹•ä½œã™ã‚‹
self.resultCancellable = self.job?.result.sink(
  receiveCompletion: { [weak self] completion in
    // ...
  },
  receiveValue: { [weak self] classifier in
    // ...
  }
)

// å‹•ä½œã—ãªã„
self.job?.result.sink(
  receiveCompletion: { [weak self] completion in
    // ...
  },
  receiveValue: { [weak self] classifier in
    // ...
  }
)
```

## ã‚ˆãã‚ã‚‹è³ªå•ã¨å›ç­”

## å‚è€ƒè³‡æ–™

1. [MLJob - Apple Developer Documentation](https://developer.apple.com/documentation/createml/mljob)
2. [MLImageClassifier.ModelParameters - Apple Developer Documentation](https://developer.apple.com/documentation/createml/mlimageclassifier/modelparameters-swift.struct)
3. [MLImageClassifier.FeatureExtractorType - Apple Developer Documentation](https://developer.apple.com/documentation/createml/mlimageclassifier/featureextractortype)
4. [MLImageClassifier.ModelParameters.ModelAlgorithmType - Apple Developer Documentation](https://developer.apple.com/documentation/createml/mlimageclassifier/modelparameters-swift.struct/modelalgorithmtype)
5. [iOSã§ã®CreateML / CoreMLã‚’ç”¨ã„ãŸã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹æ©Ÿæ¢°å­¦ç¿’ - ã‚¨ãƒ‹ã‚°ãƒ¢é–‹ç™ºè€…ãƒ–ãƒ­ã‚°](https://tech.enigmo.co.jp/entry/2022/12/20/070000)
